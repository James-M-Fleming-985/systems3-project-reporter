# ================================================================================
# LAYER REQUIREMENT: Report Assembler
# ================================================================================
# REQUIREMENT ID: REQ-003-006-004
# FEATURE: FEATURE-003-006 (PowerPoint Generator)
# LAYER: LAYER-003-006-004 (Report_Assembler)
# VERSION: 1.0.0
# STATUS: Active
# ================================================================================

metadata:
  requirement_id: "REQ-003-006-004"
  requirement_title: "Report Assembler"
  layer: "004_Report_Assembler"
  feature: "FEATURE-003-006_PowerPoint_Generator"
  version: "1.0.0"
  status: "Active"
  priority: "MUST HAVE"
  created_date: "2025-10-16"
  updated_date: "2025-10-16"
  owner: "James Fleming"
  target_date: "2025-10-31"
  change_log:
    - version: "1.0.0"
      date: "2025-10-16"
      changes: "Initial version - Report Assembler"

# ================================================================================
# REQUIREMENT DEFINITION
# ================================================================================

requirement:
  title: "Report Assembler"
  
  description: |
    Orchestrate complete report generation. Coordinate all previous layers (data reading, chart generation, milestone tracking, risk aggregation). Generate all 9 slides (3 per section), apply theme, save final PowerPoint file.
  
  rationale: |
    Top-level orchestration layer. Implements workflow from PROJECT_REQUIREMENTS.yaml, coordinates all features into cohesive report.

# ================================================================================
# SPECIFICATION
# ================================================================================

specification:
  structure:
    entry_point: "src/report_assembler/report_assembler.py"
    modules:
      - "report_assembler.py"
      - "models.py"
      - "exceptions.py"
  
  classes:
    - name: "ReportAssembler"
      purpose: "Orchestrate complete report generation"
      methods:
        - name: "generate_report"
          signature: "generate_report(output_path: Path) -> None"
          purpose: "Implement generate_report logic" 
        - name: "generate_section"
          signature: "generate_section(section_name: str, projects: List[ProjectPlan]) -> List[Slide]"
          purpose: "Implement generate_section logic" 
        - name: "validate_all_data"
          signature: "validate_all_data() -> ValidationResult"
          purpose: "Implement validate_all_data logic" 
        - name: "save_report"
          signature: "save_report(prs: Presentation, output_path: Path) -> Path"
          purpose: "Implement save_report logic" 

  implementation_details:
    libraries: ['python-pptx>=0.6.21']
    patterns: ["Repository Pattern", "Factory Pattern"]
    error_handling:
      - error_type: "ValidationError"
        handling: "Raise with clear error message"
      - error_type: "DataError"
        handling: "Log and raise custom exception"
  
  inputs:
    - name: "input_data"
      type: "Various"
      description: "All feature outputs (charts, milestones, risks, changes)" 

  outputs:
    - name: "output_data"
      type: "Various"
      description: "Complete PowerPoint file at specified path" 

# ================================================================================
# ACCEPTANCE CRITERIA
# ================================================================================

acceptance_criteria:
  - criterion: "Processes valid input data without errors"
    test: "pytest tests/unit/test_report_assembler.py -v"
  
  - criterion: "Handles invalid input with appropriate error messages"
    test: "Pass invalid data, verify exception with clear message"
  
  - criterion: "Integrates correctly with dependent layers"
    test: "pytest tests/integration/test_report_assembler_integration.py -v"
  
  - criterion: "Performance meets requirements"
    test: "Benchmark test with realistic data volume"

# ================================================================================
# TDD IMPLEMENTATION PLAN
# ================================================================================

week_1_task:
  title: "Build Report Assembler (TDD Approach)"
  
  steps:
    - step: 1
      action: "Write failing unit tests (RED phase)"
      file: "tests/unit/test_report_assembler.py"
      tests:
        - "test_generate_report_success"
        - "test_generate_report_failure" 
        - "test_generate_section_success"
        - "test_generate_section_failure" 
        - "test_validate_all_data_success"
        - "test_validate_all_data_failure" 
        - "test_save_report_success"
        - "test_save_report_failure" 
      duration: "30 min"
    
    - step: 2
      action: "Run pytest to confirm RED phase"
      command: "pytest tests/unit/test_report_assembler.py -v"
      expected: "All tests FAIL (as expected)"
      duration: "2 min"
    
    - step: 3
      action: "Implement ReportAssembler class (GREEN phase)"
      file: "src/report_assembler/report_assembler.py"
      methods:
        - "generate_report(output_path: Path) -> None" 
        - "generate_section(section_name: str, projects: List[ProjectPlan]) -> List[Slide]" 
        - "validate_all_data() -> ValidationResult" 
        - "save_report(prs: Presentation, output_path: Path) -> Path" 
      duration: "45 min"
    
    - step: 4
      action: "Run pytest to confirm GREEN phase"
      command: "pytest tests/unit/test_report_assembler.py -v"
      expected: "All tests PASS"
      duration: "5 min"
    
    - step: 5
      action: "Refactor for code quality (REFACTOR phase)"
      improvements:
        - "Add comprehensive docstrings"
        - "Extract common logic to helper methods"
        - "Add type hints to all methods"
      duration: "20 min"
    
    - step: 6
      action: "Integration test with dependent layers"
      file: "tests/integration/test_report_assembler_integration.py"
      duration: "15 min"
  
  total_time: "4 hours"
  
  deliverable: |
    Report Assembler implementation ready for integration with 
    downstream layers.

# ================================================================================
# TRACEABILITY
# ================================================================================

traceability:
  implements_project_requirements:
    - "PRJ-REQ-001: Automated PowerPoint report generation" 
    - "PRJ-REQ-002: Three-section report structure" 
    - "PRJ-REQ-005: Professional presentation with org branding" 
  
  implements_system_requirements:
    - "SYS-REQ-004: Presentation Layer" 
    - "SYS-REQ-006: Factory Pattern for slide generation" 
    - "SYS-REQ-007: Report generation < 10 seconds" 
  
  implements_system_components:
    - "COMP-006: PowerPoint Builder" 
    - "COMP-008: Report Orchestrator" 
  
  maps_to_feature:
    - "FEATURE-003-006: PowerPoint Generator"
  
  depends_on_layers:
    - "LAYER-003-006-002" 
    - "LAYER-003-006-003" 
    - "FEATURE-003-001" 
    - "FEATURE-003-002" 
    - "FEATURE-003-003" 
    - "FEATURE-003-004" 
  
  consumed_by_layers:
    []  # Terminal layer 

# ================================================================================
# INTEGRATION POINTS
# ================================================================================

integration:
  input_from:
    - layer: "LAYER-003-006-002"
      data_type: "Various"
      interface: "Method calls" 
    - layer: "LAYER-003-006-003"
      data_type: "Various"
      interface: "Method calls" 
    - layer: "FEATURE-003-001"
      data_type: "Various"
      interface: "Method calls" 
    - layer: "FEATURE-003-002"
      data_type: "Various"
      interface: "Method calls" 
    - layer: "FEATURE-003-003"
      data_type: "Various"
      interface: "Method calls" 
    - layer: "FEATURE-003-004"
      data_type: "Various"
      interface: "Method calls" 
  
  output_to:
    []  # Terminal layer, produces final output 
  
  shared_dependencies:
    - "src/models/ - Shared data models"
    - "src/exceptions/ - Shared exceptions"

# ================================================================================
# TESTING STRATEGY
# ================================================================================

testing_strategy:
  unit_tests:
    location: "tests/unit/test_report_assembler.py"
    coverage_target: "90%"
    key_scenarios:
      - "Valid input processing"
      - "Invalid input error handling"
      - "Edge cases and boundary conditions"
  
  integration_tests:
    location: "tests/integration/test_report_assembler_integration.py"
    scenarios:
      - "Integration with dependent layers"
      - "End-to-end data flow"
  
  fixtures:
    location: "tests/fixtures/report_assembler/"
    files:
      - "sample_valid_data.yaml"
      - "sample_invalid_data.yaml"
      - "edge_case_data.yaml"

# ================================================================================
# DEPLOYMENT NOTES
# ================================================================================

deployment:
  dependencies:
    - package: "python-pptx"
      version: "0.6.21"
      purpose: "Report Assembler implementation" 
  
  configuration:
    - setting: "config_key"
      value: "default_value"
      location: "config/settings.yaml"
  
  usage_example: |
    # Example of how to use this layer
    from src.report_assembler import ReportAssembler
    
    instance = ReportAssembler()
    result = instance.generate_report(data)
    print(result)

# ================================================================================
# NOTES
# ================================================================================

notes: |
  IMPORTANT CONSIDERATIONS:
  - This layer is part of FEATURE-003-006: PowerPoint Generator
  - Proper error handling is critical for downstream layers
  - Performance should be monitored with realistic data volumes
  
  DESIGN DECISIONS:
  - Chosen architecture supports extensibility
  - Error messages include actionable context
  - Separates data transformation from business logic
  
  FUTURE ENHANCEMENTS:
  - Consider async processing for performance
  - Add caching for frequently accessed data
  - Implement monitoring and metrics

# ================================================================================
# END OF LAYER REQUIREMENT
# ================================================================================
