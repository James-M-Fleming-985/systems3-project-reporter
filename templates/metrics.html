{% extends "base.html" %}

{% block title %}Metrics - Systems¬≥ Project Reporter{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">üìà Program Metrics</h2>
    <p class="text-gray-600">Key performance indicators and program health metrics</p>
</div>

<!-- Program Selection Check -->
<div id="noProgramSelected" class="bg-yellow-50 border-l-4 border-yellow-500 p-6 mb-6">
    <div class="flex items-center">
        <svg class="w-8 h-8 text-yellow-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <div>
            <h3 class="text-lg font-bold text-yellow-800 mb-2">No Program Selected</h3>
            <p class="text-yellow-700 mb-3">Please select a program from the Portfolio Dashboard to view its metrics.</p>
            <a href="/dashboard" class="inline-block px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition">
                Go to Portfolio Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Metrics Content (hidden until program selected) -->
<div id="metricsContent" class="hidden">
    
    <!-- Current Program Banner -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <p class="font-semibold text-blue-800">Viewing Metrics For: <span id="selectedProgramNameMetrics"></span></p>
                    <p class="text-sm text-blue-700">Last Updated: <span id="lastUpdated"></span></p>
                </div>
            </div>
            <a href="/dashboard" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm">
                Change Program
            </a>
        </div>
    </div>

    <!-- KPI Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Schedule Performance Index (SPI) -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-gray-600">Schedule Performance</h3>
                <div class="bg-green-100 rounded-full p-2">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-gray-900" id="spiValue">-</p>
            <p class="text-xs text-gray-500 mt-1">SPI (Target: ‚â•1.0)</p>
        </div>

        <!-- Completion Rate -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-gray-600">Completion Rate</h3>
                <div class="bg-blue-100 rounded-full p-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-gray-900" id="completionRate">-</p>
            <p class="text-xs text-gray-500 mt-1">Milestones Completed</p>
        </div>

        <!-- Risk Score -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-gray-600">Risk Score</h3>
                <div class="bg-red-100 rounded-full p-2">
                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-gray-900" id="riskScore">-</p>
            <p class="text-xs text-gray-500 mt-1">Open Risks</p>
        </div>

        <!-- Change Velocity -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-gray-600">Change Velocity</h3>
                <div class="bg-yellow-100 rounded-full p-2">
                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-gray-900" id="changeVelocity">-</p>
            <p class="text-xs text-gray-500 mt-1">Changes This Month</p>
        </div>
    </div>

    <!-- Detailed Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        
        <!-- Milestone Health Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Milestone Health</h3>
            <div id="milestoneHealthChart" style="width:100%; height:300px;"></div>
        </div>

        <!-- Risk Distribution -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Risk Distribution</h3>
            <div id="riskDistributionChart" style="width:100%; height:300px;"></div>
        </div>
    </div>

    <!-- Timeline Metrics -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Schedule Trend</h3>
        <div id="scheduleTrendChart" style="width:100%; height:400px;"></div>
    </div>

    <!-- Custom Metrics Table -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">Custom Program Metrics</h3>
            <button id="addMetricBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm">
                + Add Metric
            </button>
        </div>
        <p class="text-gray-500 text-sm mb-4">Define and track custom metrics specific to this program. Update values regularly to see trends.</p>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Metric Name
                        </th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Current Value
                        </th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Target
                        </th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Target Date
                        </th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Last Updated
                        </th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="customMetricsTable">
                    <tr id="noMetricsRow">
                        <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                            No custom metrics defined yet. Click "Add Metric" to create one.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Add/Edit Custom Metric Modal -->
<div id="addMetricModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 id="modalTitle" class="text-lg font-bold text-gray-900 mb-4">Add Custom Metric</h3>
            <form id="addMetricForm">
                <input type="hidden" id="editingMetricIndex" value="">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Metric Name</label>
                    <input type="text" id="metricName" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., Team Velocity">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Value</label>
                    <input type="number" step="0.01" id="metricValue" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., 85">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Target Value</label>
                    <input type="number" step="0.01" id="metricTarget" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., 100">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Target Date</label>
                    <input type="date" id="metricTargetDate" required
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unit (optional)</label>
                    <input type="text" id="metricUnit" 
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., points, hours, %">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelMetricBtn"
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                        Cancel
                    </button>
                    <button type="submit" id="submitMetricBtn"
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                        Add Metric
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Value Modal -->
<div id="updateValueModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Update Metric Value</h3>
            <p class="text-sm text-gray-600 mb-4">Update the current value to track progress over time</p>
            <form id="updateValueForm">
                <input type="hidden" id="updateMetricIndex" value="">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Metric Name</label>
                    <input type="text" id="updateMetricNameDisplay" disabled
                           class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100 text-gray-700">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">New Value</label>
                    <input type="number" step="0.01" id="updateMetricValue" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter new value">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelUpdateBtn"
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                        Update Value
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Metric Trend Chart Modal -->
<div id="trendChartModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-3/4 max-w-4xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 id="trendChartTitle" class="text-lg font-bold text-gray-900">Metric Trend</h3>
                <button id="closeTrendChartBtn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="metricTrendChart" style="width:100%; height:400px;"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// All initialization in one DOMContentLoaded event
document.addEventListener('DOMContentLoaded', function() {
    // Check for selected program on page load
    const selectedProgram = localStorage.getItem('selectedProgram');
    const selectedProgramCode = localStorage.getItem('selectedProgramCode');
    const noProgramDiv = document.getElementById('noProgramSelected');
    const metricsDiv = document.getElementById('metricsContent');
    const programNameSpan = document.getElementById('selectedProgramNameMetrics');
    
    console.log('=== Metrics Page Debug ===');
    console.log('Selected program from localStorage:', selectedProgram);
    console.log('Selected program code:', selectedProgramCode);
    console.log('All localStorage keys:', Object.keys(localStorage));
    console.log('All localStorage:', JSON.stringify(localStorage));
    
    if (selectedProgram && selectedProgram !== 'null' && selectedProgram.trim() !== '') {
        console.log('‚úÖ Program selected, showing metrics content');
        // Show metrics content
        if (noProgramDiv) noProgramDiv.classList.add('hidden');
        if (metricsDiv) metricsDiv.classList.remove('hidden');
        if (programNameSpan) programNameSpan.textContent = selectedProgram;
        
        // Load metrics data
        loadMetricsData(selectedProgram);
    } else {
        console.log('‚ùå No program selected, showing warning');
        // Show "no program selected" message
        if (noProgramDiv) noProgramDiv.classList.remove('hidden');
        if (metricsDiv) metricsDiv.classList.add('hidden');
    }
    
    // Initialize modal controls
    initializeModalControls();
    
    // Load custom metrics
    loadCustomMetrics();
});

function initializeModalControls() {

function loadMetricsData(programName) {
    try {
        // Use real metrics data from backend
        const metrics = {{ metrics | tojson | safe }};
        
        if (!metrics) {
            console.error('No metrics data available');
            return;
        }
        
        console.log('Loading metrics data:', metrics);
        
        // Update KPI cards with real data
        document.getElementById('spiValue').textContent = metrics.spi || '1.00';
        document.getElementById('completionRate').textContent = (metrics.completion_rate || 0) + '%';
        document.getElementById('riskScore').textContent = '-'; // Will be from risk upload
        document.getElementById('changeVelocity').textContent = '-'; // TODO: calculate from changes
        
        // Update last updated timestamp
        const lastUpdatedSpan = document.getElementById('lastUpdated');
        if (lastUpdatedSpan && metrics.last_updated) {
            const date = new Date(metrics.last_updated);
            lastUpdatedSpan.textContent = date.toLocaleString();
        }
        
        // Create charts with real data
        createMilestoneHealthChart(metrics.milestone_health || {completed: 0, in_progress: 0, not_started: 0, late: 0});
        createRiskDistributionChart(); // Placeholder until risk upload
        createScheduleTrendChart(metrics.schedule_trend || {periods: [], spi_values: []});
    } catch (error) {
        console.error('Error loading metrics data:', error);
        console.error('Error stack:', error.stack);
    }
}

function createMilestoneHealthChart(healthData) {
    // Use real milestone health data
    const data = [{
        values: [
            healthData.completed || 0,
            healthData.in_progress || 0,
            healthData.not_started || 0,
            healthData.late || 0
        ],
        labels: ['Completed', 'In Progress', 'Not Started', 'Late/Overdue'],
        type: 'pie',
        marker: {
            colors: ['#22c55e', '#eab308', '#9ca3af', '#ef4444']
        }
    }];
    
    const layout = {
        showlegend: true,
        margin: { t: 0, b: 0, l: 0, r: 0 }
    };
    
    Plotly.newPlot('milestoneHealthChart', data, layout, {responsive: true});
}

function createRiskDistributionChart() {
    // Placeholder for Plotly chart
    const data = [{
        x: ['High', 'Medium', 'Low'],
        y: [3, 4, 1],
        type: 'bar',
        marker: {
            color: ['#ef4444', '#f59e0b', '#10b981']
        }
    }];
    
    const layout = {
        yaxis: { title: 'Count' },
        margin: { t: 10, b: 40, l: 40, r: 10 }
    };
    
    Plotly.newPlot('riskDistributionChart', data, layout, {responsive: true});
}

function createScheduleTrendChart(trendData) {
    if (!trendData || !trendData.periods || trendData.periods.length === 0) {
        // Show empty state
        document.getElementById('scheduleTrendChart').innerHTML = 
            '<div class="flex items-center justify-center h-full text-gray-500">No trend data available yet</div>';
        return;
    }
    
    // Use real schedule trend data
    const data = [{
        x: trendData.periods,
        y: trendData.spi_values,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'SPI Trend',
        line: { color: '#3b82f6', width: 3 },
        marker: { size: 8 }
    }];
    
    const layout = {
        yaxis: { 
            title: 'Schedule Performance Index',
            zeroline: false
        },
        xaxis: { 
            title: 'Time Period',
            tickangle: -45
        },
        margin: { t: 10, b: 60, l: 50, r: 10 },
        shapes: [{
            type: 'line',
            x0: trendData.periods[0],
            y0: 1.0,
            x1: trendData.periods[trendData.periods.length - 1],
            y1: 1.0,
            line: {
                color: '#22c55e',
                width: 2,
                dash: 'dash'
            }
        }],
        annotations: [{
            x: trendData.periods[Math.floor(trendData.periods.length / 2)],
            y: 1.0,
            text: 'Target (1.0)',
            showarrow: false,
            yshift: 10,
            font: { size: 10, color: '#22c55e' }
        }]
    };
    
    Plotly.newPlot('scheduleTrendChart', data, layout, {responsive: true});
}

// Custom Metrics Management
let customMetrics = [];

// Load custom metrics from localStorage
function loadCustomMetrics() {
    const selectedProgram = localStorage.getItem('selectedProgram');
    if (!selectedProgram) return;
    
    const storageKey = `customMetrics_${selectedProgram}`;
    const stored = localStorage.getItem(storageKey);
    if (stored) {
        customMetrics = JSON.parse(stored);
        // Migrate old metrics to include history if needed
        customMetrics = customMetrics.map(metric => {
            if (!metric.history) {
                metric.history = [{
                    value: metric.value,
                    date: metric.lastUpdated
                }];
            }
            if (!metric.targetDate) {
                metric.targetDate = null;
            }
            return metric;
        });
        renderCustomMetrics();
    }
}

// Save custom metrics to localStorage
function saveCustomMetrics() {
    const selectedProgram = localStorage.getItem('selectedProgram');
    if (!selectedProgram) return;
    
    const storageKey = `customMetrics_${selectedProgram}`;
    localStorage.setItem(storageKey, JSON.stringify(customMetrics));
}

// Calculate status and color
function getMetricStatus(value, target) {
    const percentage = target > 0 ? (value / target) * 100 : 0;
    let status, color;
    
    if (percentage >= 100) {
        status = 'On Track';
        color = 'text-green-600';
    } else if (percentage >= 70) {
        status = 'At Risk';
        color = 'text-yellow-600';
    } else {
        status = 'Behind';
        color = 'text-red-600';
    }
    
    return { status, color, percentage: percentage.toFixed(1) };
}

// Render custom metrics table
function renderCustomMetrics() {
    const tbody = document.getElementById('customMetricsTable');
    const noMetricsRow = document.getElementById('noMetricsRow');
    
    if (customMetrics.length === 0) {
        if (noMetricsRow) {
            noMetricsRow.style.display = 'table-row';
        }
        return;
    }
    
        
    // Hide "no metrics" message
    if (noMetricsRow) {
        noMetricsRow.style.display = 'none';
    }
    
    // Clear existing rows (except no metrics row)
    const existingRows = tbody.querySelectorAll('tr:not(#noMetricsRow)');
    existingRows.forEach(row => row.remove());
    
    // Add metric rows
    customMetrics.forEach((metric, index) => {
        const { status, color, percentage } = getMetricStatus(metric.value, metric.target);
        const targetDateStr = metric.targetDate ? new Date(metric.targetDate).toLocaleDateString() : 'Not set';
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${metric.name}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${metric.value}${metric.unit ? ' ' + metric.unit : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${metric.target}${metric.unit ? ' ' + metric.unit : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                ${targetDateStr}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm ${color} font-semibold">
                ${status} (${percentage}%)
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${new Date(metric.lastUpdated).toLocaleDateString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                <button onclick="updateMetricValue(${index})" class="text-blue-600 hover:text-blue-800">Update</button>
                <button onclick="editMetric(${index})" class="text-indigo-600 hover:text-indigo-800">Edit</button>
                <button onclick="showTrendChart(${index})" class="text-green-600 hover:text-green-800">Trend</button>
                <button onclick="deleteMetric(${index})" class="text-red-600 hover:text-red-800">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
                ${status} (${percentage}%)
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${new Date(metric.lastUpdated).toLocaleDateString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button onclick="deleteMetric(${index})" class="text-red-600 hover:text-red-800">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Edit a custom metric
function editMetric(index) {
    const metric = customMetrics[index];
    
    document.getElementById('modalTitle').textContent = 'Edit Custom Metric';
    document.getElementById('submitMetricBtn').textContent = 'Save Changes';
    document.getElementById('editingMetricIndex').value = index;
    
    document.getElementById('metricName').value = metric.name;
    document.getElementById('metricValue').value = metric.value;
    document.getElementById('metricTarget').value = metric.target;
    document.getElementById('metricTargetDate').value = metric.targetDate || '';
    document.getElementById('metricUnit').value = metric.unit || '';
    
    document.getElementById('addMetricModal').classList.remove('hidden');
}

// Update metric value (keeps history)
function updateMetricValue(index) {
    const metric = customMetrics[index];
    
    document.getElementById('updateMetricNameDisplay').value = metric.name;
    document.getElementById('updateMetricValue').value = metric.value;
    document.getElementById('updateMetricIndex').value = index;
    
    document.getElementById('updateValueModal').classList.remove('hidden');
}

// Show trend chart for a metric
function showTrendChart(index) {
    const metric = customMetrics[index];
    
    if (!metric.history || metric.history.length === 0) {
        alert('No history available for this metric yet.');
        return;
    }
    
    document.getElementById('trendChartTitle').textContent = `${metric.name} - Trend Chart`;
    
    // Sort history by date
    const sortedHistory = [...metric.history].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const dates = sortedHistory.map(h => new Date(h.date).toLocaleDateString());
    const values = sortedHistory.map(h => h.value);
    
    const data = [{
        x: dates,
        y: values,
        type: 'scatter',
        mode: 'lines+markers',
        name: metric.name,
        line: { color: '#3b82f6', width: 3 },
        marker: { size: 8 }
    }];
    
    const layout = {
        yaxis: { 
            title: metric.unit ? `Value (${metric.unit})` : 'Value',
            zeroline: false
        },
        xaxis: { 
            title: 'Date',
            tickangle: -45
        },
        margin: { t: 10, b: 60, l: 60, r: 10 },
        shapes: [{
            type: 'line',
            x0: dates[0],
            y0: metric.target,
            x1: dates[dates.length - 1],
            y1: metric.target,
            line: {
                color: '#22c55e',
                width: 2,
                dash: 'dash'
            }
        }],
        annotations: [{
            x: dates[Math.floor(dates.length / 2)],
            y: metric.target,
            text: `Target (${metric.target}${metric.unit ? ' ' + metric.unit : ''})`,
            showarrow: false,
            yshift: 10,
            font: { size: 10, color: '#22c55e' }
        }]
    };
    
    Plotly.newPlot('metricTrendChart', data, layout, {responsive: true});
    document.getElementById('trendChartModal').classList.remove('hidden');
}

// Delete a custom metric
function deleteMetric(index) {
    if (confirm('Are you sure you want to delete this metric?')) {
        customMetrics.splice(index, 1);
        saveCustomMetrics();
        renderCustomMetrics();
    }
}

// Modal controls
function initializeModalControls() {
    const addMetricBtn = document.getElementById('addMetricBtn');
    const cancelMetricBtn = document.getElementById('cancelMetricBtn');
    const addMetricModal = document.getElementById('addMetricModal');
    const addMetricForm = document.getElementById('addMetricForm');
    
    const updateValueModal = document.getElementById('updateValueModal');
    const cancelUpdateBtn = document.getElementById('cancelUpdateBtn');
    const updateValueForm = document.getElementById('updateValueForm');
    
    const trendChartModal = document.getElementById('trendChartModal');
    const closeTrendChartBtn = document.getElementById('closeTrendChartBtn');
    
    // Add/Edit Metric Modal
    if (addMetricBtn) {
        addMetricBtn.addEventListener('click', function() {
            document.getElementById('modalTitle').textContent = 'Add Custom Metric';
            document.getElementById('submitMetricBtn').textContent = 'Add Metric';
            document.getElementById('editingMetricIndex').value = '';
            addMetricForm.reset();
            addMetricModal.classList.remove('hidden');
        });
    }
    
    if (cancelMetricBtn) {
        cancelMetricBtn.addEventListener('click', function() {
            addMetricModal.classList.add('hidden');
            addMetricForm.reset();
            document.getElementById('editingMetricIndex').value = '';
        });
    }
    
    if (addMetricForm) {
        addMetricForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editIndex = document.getElementById('editingMetricIndex').value;
            const value = parseFloat(document.getElementById('metricValue').value);
            
            const metricData = {
                name: document.getElementById('metricName').value,
                value: value,
                target: parseFloat(document.getElementById('metricTarget').value),
                targetDate: document.getElementById('metricTargetDate').value,
                unit: document.getElementById('metricUnit').value,
                lastUpdated: new Date().toISOString()
            };
            
            if (editIndex === '') {
                // Adding new metric
                metricData.history = [{
                    value: value,
                    date: new Date().toISOString()
                }];
                customMetrics.push(metricData);
            } else {
                // Editing existing metric
                const index = parseInt(editIndex);
                customMetrics[index] = {
                    ...customMetrics[index],
                    ...metricData,
                    history: customMetrics[index].history || [{
                        value: value,
                        date: new Date().toISOString()
                    }]
                };
            }
            
            saveCustomMetrics();
            renderCustomMetrics();
            
            addMetricModal.classList.add('hidden');
            addMetricForm.reset();
            document.getElementById('editingMetricIndex').value = '';
        });
    }
    
    // Update Value Modal
    if (cancelUpdateBtn) {
        cancelUpdateBtn.addEventListener('click', function() {
            updateValueModal.classList.add('hidden');
            updateValueForm.reset();
        });
    }
    
    if (updateValueForm) {
        updateValueForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const index = parseInt(document.getElementById('updateMetricIndex').value);
            const newValue = parseFloat(document.getElementById('updateMetricValue').value);
            
            // Add to history
            if (!customMetrics[index].history) {
                customMetrics[index].history = [];
            }
            
            customMetrics[index].history.push({
                value: newValue,
                date: new Date().toISOString()
            });
            
            // Update current value
            customMetrics[index].value = newValue;
            customMetrics[index].lastUpdated = new Date().toISOString();
            
            saveCustomMetrics();
            renderCustomMetrics();
            
            updateValueModal.classList.add('hidden');
            updateValueForm.reset();
        });
    }
    
    // Trend Chart Modal
    if (closeTrendChartBtn) {
        closeTrendChartBtn.addEventListener('click', function() {
            trendChartModal.classList.add('hidden');
        });
    }
}
</script>
{% endblock %}
