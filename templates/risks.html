{% extends "base.html" %}

{% block title %}Risk Analysis - Systems³ Project Reporter{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">⚠️ Risk Analysis</h2>
    <p class="text-gray-600">Active risks grouped by severity</p>
</div>

<!-- Risk Summary Cards -->
{% set critical_count = (standalone_risks|selectattr('severity_normalized', 'equalto', 'critical')|list|length if standalone_risks else 0) %}
{% set high_count = risk_data.counts.HIGH + (standalone_risks|selectattr('severity_normalized', 'equalto', 'high')|list|length if standalone_risks else 0) %}
{% set medium_count = risk_data.counts.MEDIUM + (standalone_risks|selectattr('severity_normalized', 'equalto', 'medium')|list|length if standalone_risks else 0) %}
{% set low_count = risk_data.counts.LOW + (standalone_risks|selectattr('severity_normalized', 'equalto', 'low')|list|length if standalone_risks else 0) %}
{% set total_count = risk_data.total + (standalone_risks|length if standalone_risks else 0) %}

<div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
        <p class="text-gray-500 text-sm mb-2">Total Risks</p>
        <p class="text-4xl font-bold text-gray-800">{{ total_count }}</p>
    </div>
    <div class="bg-purple-50 rounded-lg shadow p-6">
        <p class="text-purple-700 text-sm mb-2">CRITICAL Severity</p>
        <p class="text-4xl font-bold text-purple-700">{{ critical_count }}</p>
    </div>
    <div class="bg-red-50 rounded-lg shadow p-6">
        <p class="text-red-600 text-sm mb-2">HIGH Severity</p>
        <p class="text-4xl font-bold text-red-600">{{ high_count }}</p>
    </div>
    <div class="bg-yellow-50 rounded-lg shadow p-6">
        <p class="text-yellow-600 text-sm mb-2">MEDIUM Severity</p>
        <p class="text-4xl font-bold text-yellow-600">{{ medium_count }}</p>
    </div>
    <div class="bg-gray-50 rounded-lg shadow p-6">
        <p class="text-gray-600 text-sm mb-2">LOW Severity</p>
        <p class="text-4xl font-bold text-gray-600">{{ low_count }}</p>
    </div>
</div>

<!-- Action Buttons -->
<div class="flex justify-between items-center mb-6">
    <div class="flex gap-3">
        <button onclick="addRiskManually()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Risk Manually
        </button>
    </div>
    <div class="flex gap-3">
        <button onclick="downloadRisks('excel')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export Excel
        </button>
        <button onclick="downloadRisks('csv')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export CSV
        </button>
        <button onclick="downloadRisks('pdf')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export PDF
        </button>
    </div>
</div>

<!-- Risk Table -->
{% if standalone_risks or risk_data.total > 0 %}
<div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200" id="risksTable">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(0)">
                    Risk ID ↕
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(1)">
                    Title ↕
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(2)">
                    Project ↕
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(3)">
                    Severity ↕
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(4)">
                    Likelihood ↕
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(5)">
                    Impact ↕
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(6)">
                    Status ↕
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Owner
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Actions
                </th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% if standalone_risks %}
            {% for risk in standalone_risks %}
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    {{ risk.id }}
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">
                    <div class="font-medium">{{ risk.title }}</div>
                    <div class="text-gray-500 text-xs mt-1">{{ risk.description[:80] }}{% if risk.description|length > 80 %}...{% endif %}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ risk.project }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    {% if risk.severity_normalized == 'critical' %}
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                        CRITICAL
                    </span>
                    {% elif risk.severity_normalized == 'high' %}
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                        HIGH
                    </span>
                    {% elif risk.severity_normalized == 'medium' %}
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                        MEDIUM
                    </span>
                    {% else %}
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                        LOW
                    </span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ risk.likelihood }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ risk.impact }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ risk.status }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ risk.owner }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewRiskDetails('{{ risk.id }}')" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                    <button onclick="editRisk('{{ risk.id }}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                    <button onclick="deleteRisk('{{ risk.id }}')" class="text-red-600 hover:text-red-900">Delete</button>
                </td>
            </tr>
            {% endfor %}
            {% endif %}
            
            {% for severity in ['HIGH', 'MEDIUM', 'LOW'] %}
            {% if risk_data.by_severity[severity] %}
            {% for risk in risk_data.by_severity[severity] %}
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    {{ risk.risk_id }}
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">
                    <div class="text-gray-500 text-xs">{{ risk.description[:80] }}{% if risk.description|length > 80 %}...{% endif %}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ risk.project }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    {% if severity == 'HIGH' %}
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                        HIGH
                    </span>
                    {% elif severity == 'MEDIUM' %}
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                        MEDIUM
                    </span>
                    {% else %}
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                        LOW
                    </span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ risk.probability }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ risk.impact }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ risk.status }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    -
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewRiskDetails('{{ risk.risk_id }}')" class="text-blue-600 hover:text-blue-900">View</button>
                </td>
            </tr>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="bg-white rounded-lg shadow p-12 text-center">
    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
    </svg>
    <h3 class="mt-2 text-sm font-medium text-gray-900">No risks</h3>
    <p class="mt-1 text-sm text-gray-500">Get started by uploading a risk file or adding risks manually.</p>
    <div class="mt-6">
        <button onclick="window.location.href='/upload'" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            <svg class="mr-2 -ml-1 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Upload Risk Data
        </button>
    </div>
</div>
{% endif %}

<script>
function sortTable(columnIndex) {
    const table = document.getElementById('risksTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    rows.sort((a, b) => {
        const aValue = a.getElementsByTagName('td')[columnIndex].textContent.trim();
        const bValue = b.getElementsByTagName('td')[columnIndex].textContent.trim();
        return aValue.localeCompare(bValue);
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

function addRiskManually() {
    alert('Manual risk entry feature coming soon!');
    // TODO: Open modal for manual risk entry
}

function downloadRisks(format) {
    const programName = localStorage.getItem('selectedProgram') || 'ZnNi Line Development Plan-09.xml';
    window.location.href = `/risks/export/${programName}?format=${format}`;
}

function viewRiskDetails(riskId) {
    alert(`View details for risk: ${riskId}\n\nDetailed view coming soon!`);
    // TODO: Open modal with full risk details
}

function editRisk(riskId) {
    alert(`Edit risk: ${riskId}\n\nEdit functionality coming soon!`);
    // TODO: Open modal for editing risk
}

function deleteRisk(riskId) {
    if (confirm(`Are you sure you want to delete risk ${riskId}?`)) {
        alert('Delete functionality coming soon!');
        // TODO: Implement delete API call
    }
}
</script>
{% endblock %}
