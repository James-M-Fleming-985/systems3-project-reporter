{% extends "base.html" %}

{% block title %}Gantt Chart - SystemsÂ³ Project Reporter{% endblock %}

{% block extra_head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css">
<!-- jQuery (required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>
{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2" id="ganttPageTitle">ðŸ“… Program Roadmap</h2>
    <p class="text-gray-600" id="ganttPageSubtitle">Interactive timeline view of all projects</p>
</div>

<!-- Gantt Chart Container -->
<div class="bg-white rounded-lg shadow p-6">
    <div id="ganttChart" style="width:100%; height:auto;"></div>
    <p class="text-xs text-gray-500 mt-2 text-center">All projects visible - chart auto-sized for optimal viewing</p>
</div>

<!-- Legend -->
<div class="mt-6 bg-white rounded-lg shadow p-6">
    <h3 class="text-lg font-bold text-gray-800 mb-4">Status Legend</h3>
    <div class="flex space-x-6">
        <div class="flex items-center">
            <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
            <span class="text-sm">Completed</span>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>
            <span class="text-sm">In Progress</span>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-gray-400 rounded mr-2"></div>
            <span class="text-sm">Not Started</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Gantt chart data from backend (pre-filtered to selected project)
const ganttData = {{ gantt_data | tojson }};
const projectName = "{{ project.project_name }}";
const projectCode = "{{ project.project_code }}";

console.log('ðŸ“Š GANTT - Rendering', ganttData.length, 'milestones for', projectName);

// Global state
let currentView = 'roadmap';  // Default to roadmap view
let chartDiv = document.getElementById('ganttChart');

// Color mapping for status
const statusColors = {
    'COMPLETED': '#22c55e',      // green-500
    'IN_PROGRESS': '#eab308',    // yellow-500
    'NOT_STARTED': '#9ca3af'     // gray-400
};

// Helper function to parse dates correctly (avoid timezone issues)
function parseDate(dateStr) {
    // dateStr format: "YYYY-MM-DD"
    const [year, month, day] = dateStr.split('-').map(Number);
    return new Date(year, month - 1, day);  // month is 0-indexed
}

// Store annotation data for completion percentages
let completionAnnotations = [];

// Function to create roadmap view traces (grouped by project)
function createRoadmapViewTraces() {
    const traces = [];
    
    // Clear previous annotations
    completionAnnotations = [];
    
    // Group tasks by Resource (which contains our project groups from backend)
    const resourceGroups = {};
    ganttData.forEach(task => {
        if (!resourceGroups[task.Resource]) {
            resourceGroups[task.Resource] = [];
        }
        resourceGroups[task.Resource].push(task);
    });
    
    // Enhanced color mapping for project groups - matching app colors
    const projectGroupColors = {
        'Surface Finish Projects': '#22c55e',        // green-500
        'ZnNi Line Kardex': '#3b82f6',              // blue-500
        'ZnNi Line Chiller': '#8b5cf6',             // violet-500
        'ZnNi Line Asset': '#ec4899',               // pink-500
        'ZnNi Line Filter': '#f59e0b',              // amber-500
        'ICP Analysis Projects': '#ef4444',          // red-500
        'ZnNi Line Projects': '#6366f1',            // indigo-500
        'ZnNi Extraction': '#14b8a6',               // teal-500
        'Vat 8 Remove & Install': '#84cc16',        // lime-500
        'SF Documentation': '#06b6d4',              // cyan-500
        'ZnNi Line Development Plan-08.xml': '#6b7280'  // fallback gray
    };
    
    // Create aggregated project timeline bars
    Object.keys(resourceGroups).forEach(projectGroup => {
        const projectTasks = resourceGroups[projectGroup];
        
        // Calculate project timeline span (earliest start to latest finish)
        const startDates = projectTasks.map(task => parseDate(task.Start));
        const finishDates = projectTasks.map(task => parseDate(task.Finish));
        
        const projectStart = new Date(Math.min(...startDates));
        const projectFinish = new Date(Math.max(...finishDates));
        
        // Calculate duration in milliseconds
        const duration = projectFinish - projectStart;
        
        // Calculate completion statistics
        const completedTasks = projectTasks.filter(t => t.Status === 'COMPLETED').length;
        const inProgressTasks = projectTasks.filter(t => t.Status === 'IN_PROGRESS').length;
        const totalTasks = projectTasks.length;
        const completionPercent = Math.round((completedTasks / totalTasks) * 100);
        
        // Determine overall project status and color based on completion
        let projectStatus = 'NOT_STARTED';
        let barColor = '#9ca3af';  // gray-400 for not started
        
        if (completedTasks === totalTasks) {
            projectStatus = 'COMPLETED';
            barColor = '#22c55e';  // green-500 for completed
        } else if (inProgressTasks > 0 || completedTasks > 0) {
            projectStatus = 'IN_PROGRESS';
            barColor = '#eab308';  // yellow-500 for in progress
        }
        
        // Format dates for display
        const startStr = projectStart.toISOString().split('T')[0];
        const finishStr = projectFinish.toISOString().split('T')[0];
        
        // Debug logging
        console.log(`Project: ${projectGroup}`);
        console.log(`  Date range: ${startStr} to ${finishStr}`);
        console.log(`  Status: ${projectStatus} (${completedTasks}/${totalTasks} completed)`);
        
        // Store annotation data for this project
        completionAnnotations.push({
            x: projectFinish,
            y: projectGroup,
            text: `${completionPercent}%`
        });
        
        // Create single consolidated bar per project using base + duration
        traces.push({
            x: [duration],
            y: [projectGroup],
            base: projectStart,
            type: 'bar',
            orientation: 'h',
            marker: {
                color: barColor,
                line: {
                    color: 'rgba(0,0,0,0.2)',
                    width: 1
                },
                opacity: 0.9
            },
            name: projectGroup,
            text: '',
            textposition: 'none',
            customdata: [[projectGroup, totalTasks, completedTasks, inProgressTasks, projectStatus, startStr, finishStr, completionPercent]],
            hovertemplate: '<b>%{y}</b><br>' +
                          '<b>Timeline:</b> %{customdata[5]} â†’ %{customdata[6]}<br>' +
                          '<b>Progress:</b> %{customdata[7]}%<br>' +
                          '<b>Status:</b> %{customdata[4]}<br>' +
                          '<b>Tasks:</b> %{customdata[2]} of %{customdata[1]} completed (%{customdata[3]} in progress)' +
                          '<extra></extra>',
            showlegend: false
        });
    });
    
    return traces;
}

// Function to get layout configuration
function getLayout() {
    const title = currentView === 'detail' 
        ? 'Project Timeline - Milestone Detail View' 
        : 'Program Roadmap - Project Overview';
    
    // Calculate number of unique projects/resources for height calculation
    const uniqueResources = [...new Set(ganttData.map(task => task.Resource))];
    const projectCount = uniqueResources.length;
    
    // Professional auto-sizing: Calculate optimal bar height and chart height
    // Goal: Show all projects without scrolling, bars should be thick enough to read
    const minBarHeight = 40;  // Minimum height per bar for readability
    const maxBarHeight = 80;  // Maximum height per bar to avoid waste
    const topBottomPadding = 160;  // Space for title, axis labels, margins
    
    // Calculate bar height based on project count (more projects = thinner bars)
    let barHeight;
    if (projectCount <= 5) {
        barHeight = maxBarHeight;
    } else if (projectCount <= 10) {
        barHeight = 60;
    } else if (projectCount <= 15) {
        barHeight = 50;
    } else {
        barHeight = minBarHeight;
    }
    
    // Total chart height = (barHeight * projectCount) + padding
    const chartHeight = (barHeight * projectCount) + topBottomPadding;
    
    console.log(`ðŸ“ Auto-sizing: ${projectCount} projects Ã— ${barHeight}px = ${chartHeight}px total height`);
    
    // Create annotations for completion percentages
    const annotations = completionAnnotations.map(annot => ({
        x: annot.x,
        y: annot.y,
        xref: 'x',
        yref: 'y',
        text: annot.text,
        showarrow: false,
        font: {
            size: 14,
            color: '#1f2937',
            family: 'system-ui, -apple-system, sans-serif',
            weight: 'bold'
        },
        xanchor: 'left',
        xshift: 10,
        bgcolor: 'rgba(255, 255, 255, 0.95)',
        bordercolor: '#d1d5db',
        borderwidth: 1,
        borderpad: 5,
        borderradius: 3
    }));
    
    return {
        title: {
            text: title,
            font: { 
                size: 22,
                family: 'system-ui, -apple-system, sans-serif',
                weight: 'bold',
                color: '#111827'
            },
            x: 0.05,
            xanchor: 'left'
        },
        xaxis: {
            title: {
                text: 'Timeline',
                font: { size: 14, weight: 'bold' }
            },
            type: 'date',
            tickformat: '%b %Y',  // Short month + year (e.g., "Jan 2025")
            tickangle: -45,
            fixedrange: true,  // Disable zoom - show everything
            showgrid: true,
            gridcolor: '#e5e7eb',
            zeroline: false
        },
        yaxis: {
            title: {
                text: 'Projects',
                font: { size: 14, weight: 'bold' },
                standoff: 20
            },
            automargin: true,
            autorange: 'reversed',  // First item at top
            fixedrange: true,  // Disable zoom - show everything
            showgrid: true,
            gridcolor: '#e5e7eb',
            tickfont: { size: 12 }
        },
        barmode: 'overlay',
        bargap: 0.3,  // Gap between bars
        height: chartHeight,
        margin: {
            l: 280,  // Left margin for project names
            r: 100,  // Right margin for completion %
            t: 100,
            b: 100
        },
        hovermode: 'closest',
        plot_bgcolor: '#f9fafb',
        paper_bgcolor: 'white',
        annotations: annotations,
        dragmode: false  // Disable dragging/panning
    };
}

// Plotly configuration
const config = {
    responsive: true,
    displayModeBar: false,  // Hide zoom controls - no interaction needed
    displaylogo: false,
    staticPlot: false  // Allow hover tooltips but disable zoom/pan
};

// Function to render the chart
function renderChart() {
    const traces = createRoadmapViewTraces();  // Always use roadmap view
    const layout = getLayout();
    Plotly.newPlot(chartDiv, traces, layout, config);
}

// Update page title with program name
document.getElementById('ganttPageTitle').textContent = `ðŸ“… ${projectName} - Program Roadmap`;
document.getElementById('ganttPageSubtitle').textContent = `Interactive timeline view of ${ganttData.length} milestones`;

// Initial render
renderChart();
</script>
{% endblock %}
