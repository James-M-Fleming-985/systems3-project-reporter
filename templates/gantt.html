{% extends "base.html" %}

{% block title %}Gantt Chart - SystemsÂ³ Project Reporter{% endblock %}

{% block extra_head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css">
<!-- jQuery (required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>
{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2" id="ganttPageTitle">ðŸ“… Program Roadmap</h2>
    <p class="text-gray-600" id="ganttPageSubtitle">Interactive timeline view of all projects</p>
</div>

<!-- Gantt Chart Container -->
<div class="bg-white rounded-lg shadow p-6">
    <div id="ganttChart" style="width:100%; height:700px; overflow-y:auto;"></div>
</div>

<!-- Legend -->
<div class="mt-6 bg-white rounded-lg shadow p-6">
    <h3 class="text-lg font-bold text-gray-800 mb-4">Status Legend</h3>
    <div class="flex space-x-6">
        <div class="flex items-center">
            <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
            <span class="text-sm">Completed</span>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>
            <span class="text-sm">In Progress</span>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-gray-400 rounded mr-2"></div>
            <span class="text-sm">Not Started</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Gantt chart data from backend
// ALL projects data from backend
const allGanttData = {{ gantt_data | tojson }};
// Create simplified project list for filtering
const allProjects = [
    {% for project in projects %}
    {
        project_name: "{{ project.project_name }}",
        project_code: "{{ project.project_code }}",
        milestone_count: {{ project.milestones|length }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Get selected program from localStorage
const selectedProgram = localStorage.getItem('selectedProgram');
const selectedProjectCode = localStorage.getItem('selectedProjectCode');

console.log('ðŸ” GANTT DEBUG - Selected Program:', selectedProgram);
console.log('ðŸ” GANTT DEBUG - Selected Project Code:', selectedProjectCode);
console.log('ðŸ” GANTT DEBUG - Total milestones in allGanttData:', allGanttData.length);

// Filter ganttData to only show milestones for the selected project
let ganttData = allGanttData;
if (selectedProgram) {
    // Find the matching project
    const matchedProject = allProjects.find(p => 
        p.project_name === selectedProgram || 
        p.project_code === selectedProjectCode
    );
    
    if (matchedProject) {
        console.log('âœ… GANTT DEBUG - Matched Project:', matchedProject.project_name, '(', matchedProject.project_code, ')');
        console.log('ðŸ” GANTT DEBUG - Project has', matchedProject.milestones?.length, 'milestones');
        
        // Filter to only this project's milestones
        // Match by ProjectCode field added in backend
        ganttData = allGanttData.filter(task => {
            // Check if this milestone belongs to the selected project
            const belongsToProject = task.ProjectCode === matchedProject.project_code ||
                                   task.ProjectName === matchedProject.project_name;
            
            if (belongsToProject) {
                console.log('  âœ“ Including milestone:', task.Task, 'from project', task.ProjectCode);
            }
            return belongsToProject;
        });
        
        console.log('ðŸŽ¯ GANTT DEBUG - Filtered to', ganttData.length, 'milestones for', selectedProgram);
    } else {
        console.warn('âš ï¸ GANTT DEBUG - No matching project found for:', selectedProgram);
    }
} else {
    console.log('â„¹ï¸ GANTT DEBUG - No program selected, showing all', ganttData.length, 'milestones');
}

// Global state
let currentView = 'roadmap';  // Default to roadmap view
let chartDiv = document.getElementById('ganttChart');

// Color mapping for status
const statusColors = {
    'COMPLETED': '#22c55e',      // green-500
    'IN_PROGRESS': '#eab308',    // yellow-500
    'NOT_STARTED': '#9ca3af'     // gray-400
};

// Helper function to parse dates correctly (avoid timezone issues)
function parseDate(dateStr) {
    // dateStr format: "YYYY-MM-DD"
    const [year, month, day] = dateStr.split('-').map(Number);
    return new Date(year, month - 1, day);  // month is 0-indexed
}

// Store annotation data for completion percentages
let completionAnnotations = [];

// Function to create roadmap view traces (grouped by project)
function createRoadmapViewTraces() {
    const traces = [];
    
    // Clear previous annotations
    completionAnnotations = [];
    
    // Group tasks by Resource (which contains our project groups from backend)
    const resourceGroups = {};
    ganttData.forEach(task => {
        if (!resourceGroups[task.Resource]) {
            resourceGroups[task.Resource] = [];
        }
        resourceGroups[task.Resource].push(task);
    });
    
    // Enhanced color mapping for project groups - matching app colors
    const projectGroupColors = {
        'Surface Finish Projects': '#22c55e',        // green-500
        'ZnNi Line Kardex': '#3b82f6',              // blue-500
        'ZnNi Line Chiller': '#8b5cf6',             // violet-500
        'ZnNi Line Asset': '#ec4899',               // pink-500
        'ZnNi Line Filter': '#f59e0b',              // amber-500
        'ICP Analysis Projects': '#ef4444',          // red-500
        'ZnNi Line Projects': '#6366f1',            // indigo-500
        'ZnNi Extraction': '#14b8a6',               // teal-500
        'Vat 8 Remove & Install': '#84cc16',        // lime-500
        'SF Documentation': '#06b6d4',              // cyan-500
        'ZnNi Line Development Plan-08.xml': '#6b7280'  // fallback gray
    };
    
    // Create aggregated project timeline bars
    Object.keys(resourceGroups).forEach(projectGroup => {
        const projectTasks = resourceGroups[projectGroup];
        
        // Calculate project timeline span (earliest start to latest finish)
        const startDates = projectTasks.map(task => parseDate(task.Start));
        const finishDates = projectTasks.map(task => parseDate(task.Finish));
        
        const projectStart = new Date(Math.min(...startDates));
        const projectFinish = new Date(Math.max(...finishDates));
        
        // Calculate duration in milliseconds
        const duration = projectFinish - projectStart;
        
        // Calculate completion statistics
        const completedTasks = projectTasks.filter(t => t.Status === 'COMPLETED').length;
        const inProgressTasks = projectTasks.filter(t => t.Status === 'IN_PROGRESS').length;
        const totalTasks = projectTasks.length;
        const completionPercent = Math.round((completedTasks / totalTasks) * 100);
        
        // Determine overall project status and color based on completion
        let projectStatus = 'NOT_STARTED';
        let barColor = '#9ca3af';  // gray-400 for not started
        
        if (completedTasks === totalTasks) {
            projectStatus = 'COMPLETED';
            barColor = '#22c55e';  // green-500 for completed
        } else if (inProgressTasks > 0 || completedTasks > 0) {
            projectStatus = 'IN_PROGRESS';
            barColor = '#eab308';  // yellow-500 for in progress
        }
        
        // Format dates for display
        const startStr = projectStart.toISOString().split('T')[0];
        const finishStr = projectFinish.toISOString().split('T')[0];
        
        // Debug logging
        console.log(`Project: ${projectGroup}`);
        console.log(`  Date range: ${startStr} to ${finishStr}`);
        console.log(`  Status: ${projectStatus} (${completedTasks}/${totalTasks} completed)`);
        
        // Store annotation data for this project
        completionAnnotations.push({
            x: projectFinish,
            y: projectGroup,
            text: `${completionPercent}%`
        });
        
        // Create single consolidated bar per project using base + duration
        traces.push({
            x: [duration],
            y: [projectGroup],
            base: projectStart,
            type: 'bar',
            orientation: 'h',
            marker: {
                color: barColor,
                line: {
                    color: 'rgba(0,0,0,0.3)',
                    width: 2
                }
            },
            name: projectGroup,
            text: '',
            customdata: [[projectGroup, totalTasks, completedTasks, inProgressTasks, projectStatus, startStr, finishStr, completionPercent]],
            hovertemplate: '<b>%{y}</b><br>' +
                          'Tasks: %{customdata[1]} total<br>' +
                          'Completed: %{customdata[2]}<br>' +
                          'In Progress: %{customdata[3]}<br>' +
                          'Status: %{customdata[4]}<br>' +
                          'Timeline: %{customdata[5]} to %{customdata[6]}<br>' +
                          'Progress: %{customdata[7]}%' +
                          '<extra></extra>',
            showlegend: false
        });
    });
    
    return traces;
}

// Function to get layout configuration
function getLayout() {
    const title = currentView === 'detail' 
        ? 'Project Timeline - Milestone Detail View' 
        : 'Program Roadmap - Project Overview';
    
    // Count unique projects to set appropriate height
    const uniqueProjects = new Set(ganttData.map(t => t.Resource));
    const projectCount = uniqueProjects.size;
    const chartHeight = Math.max(500, projectCount * 50);  // 50px per project, minimum 500px
    
    // Create annotations for completion percentages
    const annotations = completionAnnotations.map(annot => ({
        x: annot.x,
        y: annot.y,
        xref: 'x',
        yref: 'y',
        text: annot.text,
        showarrow: false,
        font: {
            size: 13,
            color: '#1f2937',
            family: 'Arial, sans-serif',
            weight: 'bold'
        },
        xanchor: 'left',
        xshift: 8,
        bgcolor: 'rgba(255, 255, 255, 0.9)',
        bordercolor: '#d1d5db',
        borderwidth: 1,
        borderpad: 4
    }));
    
    return {
        title: {
            text: title,
            font: { size: 20 }
        },
        xaxis: {
            title: 'Date',
            type: 'date',
            tickformat: '%Y-%m-%d',
            tickangle: -45,  // Rotate x-axis labels to 45 degrees
            rangeslider: {
                visible: true,  // Add range slider for zooming timeline
                thickness: 0.05
            }
        },
        yaxis: {
            title: {
                text: currentView === 'detail' ? 'Milestones' : 'Projects',
                standoff: 20  // Move y-axis title away from axis to avoid nested appearance
            },
            automargin: true,
            autorange: true,
            fixedrange: false  // Allow vertical scrolling/zooming
        },
        barmode: 'overlay',
        bargap: 0.2,
        height: chartHeight,  // Dynamic height based on project count
        margin: {
            l: 250,  // Increased for longer project names
            r: 120,  // Increased for percentage labels
            t: 80,
            b: 150  // Increased bottom margin for range slider
        },
        hovermode: 'closest',
        plot_bgcolor: '#f9fafb',
        paper_bgcolor: 'white',
        annotations: annotations,  // Add completion percentage annotations
        dragmode: 'pan',  // Enable panning by default
        modebar: {
            orientation: 'v',
            bgcolor: 'rgba(255,255,255,0.9)',
            color: '#444',
            activecolor: '#1976d2'
        }
    };
}

// Plotly configuration
const config = {
    responsive: true,
    displayModeBar: true,
    displaylogo: false,
    modeBarButtonsToRemove: ['select2d', 'lasso2d'],
    modeBarButtonsToAdd: ['pan2d', 'zoom2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d'],
    scrollZoom: true,  // Enable scroll to zoom
    modeBarPosition: 'top'
};

// Function to render the chart
function renderChart() {
    const traces = createRoadmapViewTraces();  // Always use roadmap view
    const layout = getLayout();
    Plotly.newPlot(chartDiv, traces, layout, config);
}

// Update page title with program name (selectedProgram already declared above)
if (selectedProgram) {
    // Remove file extension and clean up the name
    const cleanName = selectedProgram.replace(/\.(xml|XML)$/, '').trim();
    document.getElementById('ganttPageTitle').textContent = `ðŸ“… ${cleanName} - Program Roadmap`;
    document.getElementById('ganttPageSubtitle').textContent = `Interactive timeline view of ${ganttData.length} milestones`;
} else {
    document.getElementById('ganttPageSubtitle').textContent = `Interactive timeline view of ${ganttData.length} milestones across all programs`;
}

// Initial render
renderChart();
</script>
{% endblock %}
