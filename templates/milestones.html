{% extends "base.html" %}

{% block title %}Milestone Tracker - Systems¬≥ Project Reporter{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">üìç Milestone Tracker</h2>
    <p class="text-gray-600">Milestones organized by status and timeline</p>
</div>

<!-- View Controls -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <label class="text-sm font-semibold text-gray-700">View:</label>
            <div class="flex space-x-2">
                <button onclick="switchView('status')" id="statusViewBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                    Status View
                </button>
                <button onclick="switchView('week')" id="weekViewBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition">
                    Week View
                </button>
                <button onclick="switchView('month')" id="monthViewBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition">
                    Month View
                </button>
            </div>
        </div>
        
        <div class="flex items-center space-x-4">
            <!-- Cards per column dropdown (only visible in month view) -->
            <div id="cardsPerColumnControl" class="hidden items-center space-x-2">
                <label for="cardsPerColumn" class="text-sm font-semibold text-gray-700">Cards per column:</label>
                <select id="cardsPerColumn" onchange="updateCardsPerColumn()" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="20">20</option>
                    <option value="25">25</option>
                    <option value="-1">All</option>
                </select>
            </div>
            
            <div class="flex items-center space-x-2">
                <label class="text-sm font-semibold text-gray-700">Sort by Date:</label>
                <button onclick="sortMilestones('asc')" id="sortAscBtn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition">
                    ‚¨ÜÔ∏è Ascending
                </button>
                <button onclick="sortMilestones('desc')" id="sortDescBtn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition">
                    ‚¨áÔ∏è Descending
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status View (Quadrant) - Default -->
<div id="statusView" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Completed Past -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center mb-4">
            <div class="bg-green-100 rounded-full p-2 mr-3">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Completed (<span id="completedCount">0</span>)</h3>
        </div>
        <div id="completedPastContainer" class="space-y-3 overflow-y-auto max-h-96">
            <!-- Populated by JavaScript -->
        </div>
    </div>
    
    <!-- Open Milestones -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center mb-4">
            <div class="bg-gray-100 rounded-full p-2 mr-3">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Open (<span id="openCount">0</span>)</h3>
        </div>
        <div id="openContainer" class="space-y-3 overflow-y-auto max-h-96">
            <!-- Populated by JavaScript -->
        </div>
    </div>
    
    <!-- At Risk (Upcoming Future) -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center mb-4">
            <div class="bg-yellow-100 rounded-full p-2 mr-3">
                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">At Risk (<span id="atRiskCount">0</span>)</h3>
        </div>
        <div id="atRiskContainer" class="space-y-3 overflow-y-auto max-h-96">
            <!-- Populated by JavaScript -->
        </div>
    </div>
    
    <!-- Past Due (Delayed) -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center mb-4">
            <div class="bg-red-100 rounded-full p-2 mr-3">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Past Due (<span id="pastDueCount">0</span>)</h3>
        </div>
        <div id="pastDueContainer" class="space-y-3 overflow-y-auto max-h-96">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Week View (Hidden by default) -->
<div id="weekView" class="hidden">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Last Week -->
        <div class="bg-white rounded-lg shadow p-6" style="overflow: hidden;">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìÖ Last Week</h3>
            <p class="text-sm text-gray-500 mb-4" id="lastWeekRange"></p>
            <div id="lastWeekCompleted" class="space-y-3 scrollable-milestone-container"></div>
        </div>
        
        <!-- This Week -->
        <div class="bg-white rounded-lg shadow p-6" style="overflow: hidden;">
            <h3 class="text-xl font-bold text-blue-800 mb-4">üìç This Week</h3>
            <p class="text-sm text-gray-500 mb-4" id="thisWeekRange"></p>
            <div id="thisWeekMilestones" class="space-y-3 scrollable-milestone-container"></div>
        </div>
        
        <!-- Next Week -->
        <div class="bg-white rounded-lg shadow p-6" style="overflow: hidden;">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìå Next Week</h3>
            <p class="text-sm text-gray-500 mb-4" id="nextWeekRange"></p>
            <div id="nextWeekMilestones" class="space-y-3 scrollable-milestone-container"></div>
        </div>
    </div>
</div>

<!-- Month View (Hidden by default) -->
<div id="monthView" class="hidden">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Last Month -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìÖ Last Month</h3>
            <p class="text-sm text-gray-500 mb-4" id="lastMonthRange"></p>
            <div id="lastMonthCompleted" class="space-y-3 overflow-y-auto" style="max-height: 900px;"></div>  <!-- 50% increase from 600px -->
        </div>
        
        <!-- This Month -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold text-blue-800 mb-4">üìç This Month</h3>
            <p class="text-sm text-gray-500 mb-4" id="thisMonthRange"></p>
            <div id="thisMonthMilestones" class="space-y-3 overflow-y-auto" style="max-height: 900px;"></div>  <!-- 50% increase from 600px -->
        </div>
        
        <!-- Next Month -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìå Next Month</h3>
            <p class="text-sm text-gray-500 mb-4" id="nextMonthRange"></p>
            <div id="nextMonthMilestones" class="space-y-3 overflow-y-auto" style="max-height: 900px;"></div>  <!-- 50% increase from 600px -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// All milestones data from server
const allMilestones = {{ quadrants | tojson }};

// Current sort order
let currentSortOrder = 'asc'; // Default ascending

// Sort milestones by target date
function sortMilestones(order) {
    currentSortOrder = order;
    
    // Update button styles
    const ascBtn = document.getElementById('sortAscBtn');
    const descBtn = document.getElementById('sortDescBtn');
    
    if (order === 'asc') {
        ascBtn.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition';
        descBtn.className = 'px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition';
    } else {
        ascBtn.className = 'px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition';
        descBtn.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition';
    }
    
    // Sort all quadrants
    const sortFn = (a, b) => {
        const dateA = new Date(a.target_date);
        const dateB = new Date(b.target_date);
        return order === 'asc' ? dateA - dateB : dateB - dateA;
    };
    
    allMilestones.completed_past.sort(sortFn);
    allMilestones.open.sort(sortFn);
    allMilestones.upcoming_future.sort(sortFn);
    allMilestones.delayed.sort(sortFn);
    
    // Re-render current view
    const currentView = document.querySelector('[id$="View"]:not(.hidden)');
    if (currentView) {
        const viewName = currentView.id.replace('View', '');
        switchView(viewName);
    }
}

// Date helper functions
function getWeekRange(date) {
    const start = new Date(date);
    start.setDate(start.getDate() - start.getDay()); // Start of week (Sunday)
    const end = new Date(start);
    end.setDate(end.getDate() + 6); // End of week (Saturday)
    return { start, end };
}

function getMonthRange(date) {
    const start = new Date(date.getFullYear(), date.getMonth(), 1);
    const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    return { start, end };
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function formatDateRange(start, end) {
    const options = { month: 'short', day: 'numeric', year: 'numeric' };
    return `${start.toLocaleDateString('en-US', options)} - ${end.toLocaleDateString('en-US', options)}`;
}

function isDateInRange(dateStr, start, end) {
    const date = new Date(dateStr);
    return date >= start && date <= end;
}

// Milestone rendering function
function renderMilestone(milestone, showStatus = true) {
    const statusColors = {
        'COMPLETED': 'green',
        'IN_PROGRESS': 'yellow',
        'NOT_STARTED': 'gray'
    };
    
    const statusIcons = {
        'COMPLETED': '‚úì',
        'IN_PROGRESS': '‚è≥',
        'NOT_STARTED': '‚óã'
    };
    
    const color = statusColors[milestone.status] || 'gray';
    const icon = statusIcons[milestone.status] || '‚óã';
    
    let html = `
        <div class="border-l-4 border-${color}-500 bg-${color}-50 p-3 rounded overflow-hidden min-h-[140px]">
            <p class="font-semibold text-gray-800">${milestone.name}</p>
            <p class="text-sm font-medium text-gray-700">${milestone.project}</p>`;
    
    if (milestone.parent_project) {
        html += `<p class="text-xs text-gray-500">üìÇ ${milestone.parent_project}</p>`;
    }
    
    html += `<p class="text-xs text-gray-500">Target: ${milestone.target_date}</p>`;
    
    if (milestone.resources) {
        html += `<p class="text-xs text-gray-600 mt-1">üë§ ${milestone.resources}</p>`;
    }
    
    if (showStatus) {
        html += `<p class="text-xs text-${color}-600 mt-1">${icon} ${milestone.status.replace('_', ' ')}</p>`;
    }
    
    if (milestone.completion_percentage) {
        html += `
            <div class="mt-2">
                <div class="w-full bg-gray-200 rounded-full h-1.5">
                    <div class="bg-${color}-500 h-1.5 rounded-full" style="width: ${milestone.completion_percentage}%"></div>
                </div>
            </div>`;
    }
    
    html += `</div>`;
    return html;
}

// Populate week view
function populateWeekView() {
    const today = new Date();
    const lastWeek = new Date(today);
    lastWeek.setDate(lastWeek.getDate() - 7);
    const nextWeek = new Date(today);
    nextWeek.setDate(nextWeek.getDate() + 7);
    
    const lastWeekRange = getWeekRange(lastWeek);
    const thisWeekRange = getWeekRange(today);
    const nextWeekRange = getWeekRange(nextWeek);
    
    document.getElementById('lastWeekRange').textContent = formatDateRange(lastWeekRange.start, lastWeekRange.end);
    document.getElementById('thisWeekRange').textContent = formatDateRange(thisWeekRange.start, thisWeekRange.end);
    document.getElementById('nextWeekRange').textContent = formatDateRange(nextWeekRange.start, nextWeekRange.end);
    
    const allMilestonesList = [
        ...allMilestones.completed_past,
        ...allMilestones.open,
        ...allMilestones.upcoming_future,
        ...allMilestones.delayed
    ];
    
    const lastWeekCompleted = allMilestonesList.filter(m => 
        m.status === 'COMPLETED' && isDateInRange(m.target_date, lastWeekRange.start, lastWeekRange.end)
    );
    
    const thisWeekMilestones = allMilestonesList.filter(m => 
        isDateInRange(m.target_date, thisWeekRange.start, thisWeekRange.end)
    );
    
    const nextWeekMilestones = allMilestonesList.filter(m => 
        isDateInRange(m.target_date, nextWeekRange.start, nextWeekRange.end)
    );
    
    document.getElementById('lastWeekCompleted').innerHTML = lastWeekCompleted.length > 0
        ? lastWeekCompleted.map(m => renderMilestone(m)).join('')
        : '<p class="text-sm text-gray-500">No milestones completed</p>';
    
    document.getElementById('thisWeekMilestones').innerHTML = thisWeekMilestones.length > 0
        ? thisWeekMilestones.map(m => renderMilestone(m)).join('')
        : '<p class="text-sm text-gray-500">No milestones scheduled</p>';
    
    document.getElementById('nextWeekMilestones').innerHTML = nextWeekMilestones.length > 0
        ? nextWeekMilestones.map(m => renderMilestone(m)).join('')
        : '<p class="text-sm text-gray-500">No milestones scheduled</p>';
    
    // Force scroll properties after content is loaded
    setTimeout(() => {
        ['lastWeekCompleted', 'thisWeekMilestones', 'nextWeekMilestones'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.overflowY = 'auto';
                el.style.height = '850px';
                el.style.display = 'block';
            }
        });
    }, 100);
}

// Populate month view
function populateMonthView() {
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
    
    const lastMonthRange = getMonthRange(lastMonth);
    const thisMonthRange = getMonthRange(today);
    const nextMonthRange = getMonthRange(nextMonth);
    
    document.getElementById('lastMonthRange').textContent = formatDateRange(lastMonthRange.start, lastMonthRange.end);
    document.getElementById('thisMonthRange').textContent = formatDateRange(thisMonthRange.start, thisMonthRange.end);
    document.getElementById('nextMonthRange').textContent = formatDateRange(nextMonthRange.start, nextMonthRange.end);
    
    const allMilestonesList = [
        ...allMilestones.completed_past,
        ...allMilestones.open,
        ...allMilestones.upcoming_future,
        ...allMilestones.delayed
    ];
    
    let lastMonthCompleted = allMilestonesList.filter(m => 
        m.status === 'COMPLETED' && isDateInRange(m.target_date, lastMonthRange.start, lastMonthRange.end)
    );
    
    let thisMonthMilestones = allMilestonesList.filter(m => 
        isDateInRange(m.target_date, thisMonthRange.start, thisMonthRange.end)
    );
    
    let nextMonthMilestones = allMilestonesList.filter(m => 
        isDateInRange(m.target_date, nextMonthRange.start, nextMonthRange.end)
    );
    
    // Apply card limit if set (skip if -1 which means "All")
    const cardLimit = parseInt(localStorage.getItem('milestonesCardsPerColumn') || '15');
    console.log('Applying card limit:', cardLimit, 'to', lastMonthCompleted.length, thisMonthMilestones.length, nextMonthMilestones.length, 'milestones');
    if (cardLimit > 0 && cardLimit !== -1) {
        lastMonthCompleted = lastMonthCompleted.slice(0, cardLimit);
        thisMonthMilestones = thisMonthMilestones.slice(0, cardLimit);
        nextMonthMilestones = nextMonthMilestones.slice(0, cardLimit);
        console.log('After limit:', lastMonthCompleted.length, thisMonthMilestones.length, nextMonthMilestones.length);
    }
    
    document.getElementById('lastMonthCompleted').innerHTML = lastMonthCompleted.length > 0
        ? lastMonthCompleted.map(m => renderMilestone(m)).join('')
        : '<p class="text-sm text-gray-500">No milestones completed</p>';
    
    document.getElementById('thisMonthMilestones').innerHTML = thisMonthMilestones.length > 0
        ? thisMonthMilestones.map(m => renderMilestone(m)).join('')
        : '<p class="text-sm text-gray-500">No milestones scheduled</p>';
    
    document.getElementById('nextMonthMilestones').innerHTML = nextMonthMilestones.length > 0
        ? nextMonthMilestones.map(m => renderMilestone(m)).join('')
        : '<p class="text-sm text-gray-500">No milestones scheduled</p>';
}

// Update cards per column setting
function updateCardsPerColumn() {
    const select = document.getElementById('cardsPerColumn');
    const value = select.value;
    console.log('Cards per column changed to:', value);
    localStorage.setItem('milestonesCardsPerColumn', value);
    populateMonthView();
}

// Populate status view (quadrant view)
function populateStatusView() {
    // Completed Past quadrant
    document.getElementById('completedPastContainer').innerHTML = allMilestones.completed_past.length > 0
        ? allMilestones.completed_past.map(m => renderMilestoneCard(m, 'green')).join('')
        : '<p class="text-sm text-gray-500">No completed milestones</p>';
    
    // Open quadrant
    document.getElementById('openContainer').innerHTML = allMilestones.open.length > 0
        ? allMilestones.open.map(m => renderMilestoneCard(m, 'gray')).join('')
        : '<p class="text-sm text-gray-500">No open milestones</p>';
    
    // At Risk quadrant
    document.getElementById('atRiskContainer').innerHTML = allMilestones.upcoming_future.length > 0
        ? allMilestones.upcoming_future.map(m => renderMilestoneCard(m, 'yellow')).join('')
        : '<p class="text-sm text-gray-500">No at-risk milestones</p>';
    
    // Past Due quadrant
    document.getElementById('pastDueContainer').innerHTML = allMilestones.delayed.length > 0
        ? allMilestones.delayed.map(m => renderMilestoneCard(m, 'red')).join('')
        : '<p class="text-sm text-gray-500">No past due milestones</p>';
    
    // Update counts in headers
    document.getElementById('completedCount').textContent = allMilestones.completed_past.length;
    document.getElementById('openCount').textContent = allMilestones.open.length;
    document.getElementById('atRiskCount').textContent = allMilestones.upcoming_future.length;
    document.getElementById('pastDueCount').textContent = allMilestones.delayed.length;
}

// Render milestone card for status view
function renderMilestoneCard(milestone, color) {
    let html = `
        <div class="border-l-4 border-${color}-500 bg-${color}-50 p-3 rounded overflow-hidden min-h-[140px]">
            <p class="font-semibold text-gray-800 truncate" title="${milestone.name}">${milestone.name}</p>
            <p class="text-sm font-medium text-gray-700 truncate" title="${milestone.project}">${milestone.project}</p>`;
    
    if (milestone.parent_project) {
        html += `<p class="text-xs text-gray-500 truncate" title="${milestone.parent_project}">üìÇ ${milestone.parent_project}</p>`;
    }
    
    html += `<p class="text-xs text-gray-500">Target: ${milestone.target_date}</p>`;
    
    if (milestone.resources) {
        html += `<p class="text-xs text-gray-600 mt-1 truncate" title="${milestone.resources}">üë§ ${milestone.resources}</p>`;
    }
    
    if (milestone.completion_percentage) {
        html += `
            <div class="mt-2">
                <div class="w-full bg-gray-200 rounded-full h-1.5">
                    <div class="bg-${color}-500 h-1.5 rounded-full" style="width: ${milestone.completion_percentage}%"></div>
                </div>
            </div>`;
    }
    
    html += '</div>';
    return html;
}

// Switch view function
function switchView(view) {
    const statusView = document.getElementById('statusView');
    const weekView = document.getElementById('weekView');
    const monthView = document.getElementById('monthView');
    const cardsPerColumnControl = document.getElementById('cardsPerColumnControl');
    
    const statusBtn = document.getElementById('statusViewBtn');
    const weekBtn = document.getElementById('weekViewBtn');
    const monthBtn = document.getElementById('monthViewBtn');
    
    // Hide all views and controls
    statusView.classList.add('hidden');
    weekView.classList.add('hidden');
    monthView.classList.add('hidden');
    cardsPerColumnControl.classList.add('hidden');
    cardsPerColumnControl.classList.remove('flex');
    
    // Reset button styles
    const inactiveClass = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition';
    const activeClass = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition';
    
    statusBtn.className = inactiveClass;
    weekBtn.className = inactiveClass;
    monthBtn.className = inactiveClass;
    
    // Show selected view
    if (view === 'status') {
        populateStatusView();
        statusView.classList.remove('hidden');
        statusBtn.className = activeClass;
    } else if (view === 'week') {
        populateWeekView();
        weekView.classList.remove('hidden');
        weekBtn.className = activeClass;
    } else if (view === 'month') {
        console.log('Switching to month view, showing cards per column control');
        populateMonthView();
        monthView.classList.remove('hidden');
        monthBtn.className = activeClass;
        cardsPerColumnControl.classList.remove('hidden');
        cardsPerColumnControl.classList.add('flex');
        console.log('Cards per column control display:', window.getComputedStyle(cardsPerColumnControl).display);
    }
}

// Initialize view on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load saved cards per column preference
    const savedLimit = localStorage.getItem('milestonesCardsPerColumn') || '15';
    document.getElementById('cardsPerColumn').value = savedLimit;
    
    populateStatusView();
});
</script>
{% endblock %}
