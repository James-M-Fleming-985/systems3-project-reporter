{% extends "base.html" %}

{% block title %}Milestone Tracker - Systems¬≥ Project Reporter{% endblock %}

{% block content %}
<!-- Notification Modal -->
<div id="notificationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-0 border w-11/12 md:w-2/3 lg:w-1/3 shadow-xl rounded-lg bg-white">
        <div id="notificationContent"></div>
    </div>
</div>

<!-- Edit Milestone Modal -->
<div id="editMilestoneModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/3 shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-800">Edit Milestone</h3>
            <button onclick="closeMilestoneModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="editMilestoneForm" class="space-y-4">
            <input type="hidden" id="milestoneIndex" />
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Milestone Name</label>
                <input type="text" id="milestoneName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Target Date</label>
                <input type="date" id="milestoneTargetDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="milestoneStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="NOT_STARTED">Not Started</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="COMPLETED">Completed</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Resources</label>
                <input type="text" id="milestoneResources" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Completion Percentage (0-100)</label>
                <input type="number" id="milestoneCompletion" min="0" max="100" placeholder="Enter 0-100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeMilestoneModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2" id="milestonePageTitle">üìç Milestone Tracker</h2>
    <p class="text-gray-600" id="milestonePageSubtitle">Milestones organized by status and timeline</p>
</div>

<!-- View Controls -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <label class="text-sm font-semibold text-gray-700">View:</label>
            <div class="flex space-x-2">
                <button onclick="switchView('status')" id="statusViewBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                    Status View
                </button>
                <button onclick="switchView('week')" id="weekViewBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition">
                    Week View
                </button>
                <button onclick="switchView('month')" id="monthViewBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition">
                    Month View
                </button>
            </div>
        </div>
        
        <div class="flex items-center space-x-4">
            <!-- Cards per column dropdown (only visible in month view) -->
            <div id="cardsPerColumnControl" class="hidden items-center space-x-2">
                <label for="cardsPerColumn" class="text-sm font-semibold text-gray-700">Cards per column:</label>
                <select id="cardsPerColumn" onchange="updateCardsPerColumn()" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="-1">Normal</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
            </div>
            
            <div class="flex items-center space-x-2">
                <label class="text-sm font-semibold text-gray-700">Sort by Date:</label>
                <button onclick="sortMilestones('asc')" id="sortAscBtn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition">
                    ‚¨ÜÔ∏è Ascending
                </button>
                <button onclick="sortMilestones('desc')" id="sortDescBtn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition">
                    ‚¨áÔ∏è Descending
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status View (Quadrant) - Default -->
<div id="statusView" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Completed Past -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center mb-4">
            <div class="bg-green-100 rounded-full p-2 mr-3">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Completed (<span id="completedCount">0</span>)</h3>
        </div>
        <div id="completedPastContainer" class="space-y-3 overflow-y-auto max-h-96">
            <!-- Populated by JavaScript -->
        </div>
    </div>
    
    <!-- Open Milestones -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center mb-4">
            <div class="bg-gray-100 rounded-full p-2 mr-3">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Open (<span id="openCount">0</span>)</h3>
        </div>
        <div id="openContainer" class="space-y-3 overflow-y-auto max-h-96">
            <!-- Populated by JavaScript -->
        </div>
    </div>
    
    <!-- At Risk (Upcoming Future) -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center mb-4">
            <div class="bg-yellow-100 rounded-full p-2 mr-3">
                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">At Risk (<span id="atRiskCount">0</span>)</h3>
        </div>
        <div id="atRiskContainer" class="space-y-3 overflow-y-auto max-h-96">
            <!-- Populated by JavaScript -->
        </div>
    </div>
    
    <!-- Past Due (Delayed) -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center mb-4">
            <div class="bg-red-100 rounded-full p-2 mr-3">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Past Due (<span id="pastDueCount">0</span>)</h3>
        </div>
        <div id="pastDueContainer" class="space-y-3 overflow-y-auto max-h-96">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Week View (Hidden by default) -->
<div id="weekView" class="hidden">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Last Week -->
        <div class="bg-white rounded-lg shadow p-6" style="overflow: hidden;">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìÖ Last Week</h3>
            <p class="text-sm text-gray-500 mb-4" id="lastWeekRange"></p>
            <div id="lastWeekCompleted" class="space-y-3 scrollable-milestone-container"></div>
        </div>
        
        <!-- This Week -->
        <div class="bg-white rounded-lg shadow p-6" style="overflow: hidden;">
            <h3 class="text-xl font-bold text-blue-800 mb-4">üìç This Week</h3>
            <p class="text-sm text-gray-500 mb-4" id="thisWeekRange"></p>
            <div id="thisWeekMilestones" class="space-y-3 scrollable-milestone-container"></div>
        </div>
        
        <!-- Next Week -->
        <div class="bg-white rounded-lg shadow p-6" style="overflow: hidden;">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìå Next Week</h3>
            <p class="text-sm text-gray-500 mb-4" id="nextWeekRange"></p>
            <div id="nextWeekMilestones" class="space-y-3 scrollable-milestone-container"></div>
        </div>
    </div>
</div>

<!-- Month View (Hidden by default) -->
<div id="monthView" class="hidden">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Last Month -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìÖ Last Month</h3>
            <p class="text-sm text-gray-500 mb-4" id="lastMonthRange"></p>
            <div id="lastMonthCompleted" class="space-y-2 overflow-y-auto" style="max-height: 800px;"></div>
        </div>
        
        <!-- This Month -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold text-blue-800 mb-4">üìç This Month</h3>
            <p class="text-sm text-gray-500 mb-4" id="thisMonthRange"></p>
            <div id="thisMonthMilestones" class="space-y-2 overflow-y-auto" style="max-height: 800px;"></div>
        </div>
        
        <!-- Next Month -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìå Next Month</h3>
            <p class="text-sm text-gray-500 mb-4" id="nextMonthRange"></p>
            <div id="nextMonthMilestones" class="space-y-2 overflow-y-auto" style="max-height: 800px;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// All milestones data from server
const allMilestones = {{ quadrants | tojson | safe }};

// Validate and log milestone data
console.log('Loaded milestones:', allMilestones);
if (allMilestones) {
    const sampleMilestone = [...(allMilestones.completed_past || []), ...(allMilestones.open || [])][0];
    if (sampleMilestone) {
        console.log('Sample milestone project field:', sampleMilestone.project);
    }
}

// Current sort order
let currentSortOrder = 'asc'; // Default ascending

// Sort milestones by target date
function sortMilestones(order) {
    currentSortOrder = order;
    
    // Update button styles
    const ascBtn = document.getElementById('sortAscBtn');
    const descBtn = document.getElementById('sortDescBtn');
    
    if (order === 'asc') {
        ascBtn.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition';
        descBtn.className = 'px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition';
    } else {
        ascBtn.className = 'px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition';
        descBtn.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition';
    }
    
    // Sort all quadrants
    const sortFn = (a, b) => {
        const dateA = new Date(a.target_date);
        const dateB = new Date(b.target_date);
        return order === 'asc' ? dateA - dateB : dateB - dateA;
    };
    
    allMilestones.completed_past.sort(sortFn);
    allMilestones.open.sort(sortFn);
    allMilestones.upcoming_future.sort(sortFn);
    allMilestones.delayed.sort(sortFn);
    
    // Re-render current view
    const currentView = document.querySelector('[id$="View"]:not(.hidden)');
    if (currentView) {
        const viewName = currentView.id.replace('View', '');
        switchView(viewName);
    }
}

// Date helper functions
function getWeekRange(date) {
    const start = new Date(date);
    start.setDate(start.getDate() - start.getDay()); // Start of week (Sunday)
    const end = new Date(start);
    end.setDate(end.getDate() + 6); // End of week (Saturday)
    return { start, end };
}

function getMonthRange(date) {
    const start = new Date(date.getFullYear(), date.getMonth(), 1);
    const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    return { start, end };
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function formatDateRange(start, end) {
    const options = { month: 'short', day: 'numeric', year: 'numeric' };
    return `${start.toLocaleDateString('en-US', options)} - ${end.toLocaleDateString('en-US', options)}`;
}

function isDateInRange(dateStr, start, end) {
    const date = new Date(dateStr);
    return date >= start && date <= end;
}

// Milestone rendering function
function renderMilestone(milestone, showStatus = true, cardHeight = 'min-h-[140px]', milestoneIndex = -1) {
    const statusColors = {
        'COMPLETED': 'green',
        'IN_PROGRESS': 'yellow',
        'NOT_STARTED': 'gray'
    };
    
    const statusIcons = {
        'COMPLETED': '‚úì',
        'IN_PROGRESS': '‚è≥',
        'NOT_STARTED': '‚óã'
    };
    
    const color = statusColors[milestone.status] || 'gray';
    const icon = statusIcons[milestone.status] || '‚óã';
    
    let html = `
        <div class="border-l-4 border-${color}-500 bg-${color}-50 p-3 rounded overflow-hidden ${cardHeight} cursor-pointer hover:shadow-md transition-shadow" onclick="editMilestone(${milestoneIndex})">
            <p class="font-semibold text-gray-800 text-sm">${milestone.name}</p>
    `;
    
    if (milestone.parent_project) {
        html += `<p class="text-xs text-gray-500">üìÇ ${milestone.parent_project}</p>`;
    }
    
    html += `<p class="text-xs text-gray-500">Target: ${milestone.target_date}</p>`;
    
    if (milestone.resources) {
        html += `<p class="text-xs text-gray-600 mt-1">üë§ ${milestone.resources}</p>`;
    }
    
    if (showStatus) {
        html += `<p class="text-xs text-${color}-600 mt-1">${icon} ${milestone.status.replace('_', ' ')}</p>`;
    }
    
    if (milestone.completion_percentage) {
        html += `
            <div class="mt-2">
                <div class="w-full bg-gray-200 rounded-full h-1.5">
                    <div class="bg-${color}-500 h-1.5 rounded-full" style="width: ${milestone.completion_percentage}%"></div>
                </div>
            </div>`;
    }
    
    html += `</div>`;
    return html;
}

// Populate week view
function populateWeekView() {
    const today = new Date();
    const lastWeek = new Date(today);
    lastWeek.setDate(lastWeek.getDate() - 7);
    const nextWeek = new Date(today);
    nextWeek.setDate(nextWeek.getDate() + 7);
    
    const lastWeekRange = getWeekRange(lastWeek);
    const thisWeekRange = getWeekRange(today);
    const nextWeekRange = getWeekRange(nextWeek);
    
    document.getElementById('lastWeekRange').textContent = formatDateRange(lastWeekRange.start, lastWeekRange.end);
    document.getElementById('thisWeekRange').textContent = formatDateRange(thisWeekRange.start, thisWeekRange.end);
    document.getElementById('nextWeekRange').textContent = formatDateRange(nextWeekRange.start, nextWeekRange.end);
    
    // Build flat array for editing with indices
    allMilestonesFlat = [
        ...allMilestones.completed_past,
        ...allMilestones.open,
        ...allMilestones.upcoming_future,
        ...allMilestones.delayed
    ];
    
    const lastWeekCompleted = allMilestonesFlat.filter(m => 
        m.status === 'COMPLETED' && isDateInRange(m.target_date, lastWeekRange.start, lastWeekRange.end)
    );
    
    const thisWeekMilestones = allMilestonesFlat.filter(m => 
        isDateInRange(m.target_date, thisWeekRange.start, thisWeekRange.end)
    );
    
    const nextWeekMilestones = allMilestonesFlat.filter(m => 
        isDateInRange(m.target_date, nextWeekRange.start, nextWeekRange.end)
    );
    
    document.getElementById('lastWeekCompleted').innerHTML = lastWeekCompleted.length > 0
        ? lastWeekCompleted.map(m => {
            const index = allMilestonesFlat.indexOf(m);
            return renderMilestone(m, true, 'min-h-[140px]', index);
        }).join('')
        : '<p class="text-sm text-gray-500">No milestones completed</p>';
    
    document.getElementById('thisWeekMilestones').innerHTML = thisWeekMilestones.length > 0
        ? thisWeekMilestones.map(m => {
            const index = allMilestonesFlat.indexOf(m);
            return renderMilestone(m, true, 'min-h-[140px]', index);
        }).join('')
        : '<p class="text-sm text-gray-500">No milestones scheduled</p>';
    
    document.getElementById('nextWeekMilestones').innerHTML = nextWeekMilestones.length > 0
        ? nextWeekMilestones.map(m => {
            const index = allMilestonesFlat.indexOf(m);
            return renderMilestone(m, true, 'min-h-[140px]', index);
        }).join('')
        : '<p class="text-sm text-gray-500">No milestones scheduled</p>';
    
    // Force scroll properties after content is loaded
    setTimeout(() => {
        ['lastWeekCompleted', 'thisWeekMilestones', 'nextWeekMilestones'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.overflowY = 'auto';
                el.style.height = '850px';
                el.style.display = 'block';
            }
        });
    }, 100);
}

// Populate month view
function populateMonthView() {
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
    
    const lastMonthRange = getMonthRange(lastMonth);
    const thisMonthRange = getMonthRange(today);
    const nextMonthRange = getMonthRange(nextMonth);
    
    document.getElementById('lastMonthRange').textContent = formatDateRange(lastMonthRange.start, lastMonthRange.end);
    document.getElementById('thisMonthRange').textContent = formatDateRange(thisMonthRange.start, thisMonthRange.end);
    document.getElementById('nextMonthRange').textContent = formatDateRange(nextMonthRange.start, nextMonthRange.end);
    
    // Build flat array for editing with indices
    allMilestonesFlat = [
        ...allMilestones.completed_past,
        ...allMilestones.open,
        ...allMilestones.upcoming_future,
        ...allMilestones.delayed
    ];
    
    let lastMonthCompleted = allMilestonesFlat.filter(m => 
        m.status === 'COMPLETED' && isDateInRange(m.target_date, lastMonthRange.start, lastMonthRange.end)
    );
    
    let thisMonthMilestones = allMilestonesFlat.filter(m => 
        isDateInRange(m.target_date, thisMonthRange.start, thisMonthRange.end)
    );
    
    let nextMonthMilestones = allMilestonesFlat.filter(m => 
        isDateInRange(m.target_date, nextMonthRange.start, nextMonthRange.end)
    );
    
    // Apply card limit if set (skip if -1 which means "Normal" view)
    const cardLimit = parseInt(localStorage.getItem('milestonesCardsPerColumn') || '-1');
    console.log('Applying card limit:', cardLimit, 'to', lastMonthCompleted.length, thisMonthMilestones.length, nextMonthMilestones.length, 'milestones');
    
    // Calculate dynamic card height based on card limit to fit within fixed container
    // Container height is 800px, need to account for spacing
    let cardHeight = 'min-h-[140px]';
    let spacing = 'space-y-3';
    
    if (cardLimit > 0) {
        // Slice arrays to the selected limit
        lastMonthCompleted = lastMonthCompleted.slice(0, cardLimit);
        thisMonthMilestones = thisMonthMilestones.slice(0, cardLimit);
        nextMonthMilestones = nextMonthMilestones.slice(0, cardLimit);
        console.log('After limit:', lastMonthCompleted.length, thisMonthMilestones.length, nextMonthMilestones.length);
        
        // Adjust card height and spacing based on number of cards to fit in ~800px container
        if (cardLimit === 5) {
            cardHeight = 'min-h-[140px] max-h-[140px]';
            spacing = 'space-y-3';
        } else if (cardLimit === 6) {
            cardHeight = 'min-h-[115px] max-h-[115px]';
            spacing = 'space-y-2';
        } else if (cardLimit === 7) {
            cardHeight = 'min-h-[98px] max-h-[98px]';
            spacing = 'space-y-2';
        } else if (cardLimit === 8) {
            cardHeight = 'min-h-[85px] max-h-[85px]';
            spacing = 'space-y-2';
        } else if (cardLimit === 9) {
            cardHeight = 'min-h-[75px] max-h-[75px]';
            spacing = 'space-y-2';
        } else if (cardLimit === 10) {
            cardHeight = 'min-h-[68px] max-h-[68px]';
            spacing = 'space-y-2';
        }
    }
    // else: cardLimit is -1 (Normal), use default full-size cards with scrolling
    
    // Update container spacing
    document.getElementById('lastMonthCompleted').className = `${spacing} overflow-y-auto`;
    document.getElementById('thisMonthMilestones').className = `${spacing} overflow-y-auto`;
    document.getElementById('nextMonthMilestones').className = `${spacing} overflow-y-auto`;
    
    document.getElementById('lastMonthCompleted').innerHTML = lastMonthCompleted.length > 0
        ? lastMonthCompleted.map(m => {
            const index = allMilestonesFlat.indexOf(m);
            return renderMilestone(m, true, cardHeight, index);
        }).join('')
        : '<p class="text-sm text-gray-500">No milestones completed</p>';
    
    document.getElementById('thisMonthMilestones').innerHTML = thisMonthMilestones.length > 0
        ? thisMonthMilestones.map(m => {
            const index = allMilestonesFlat.indexOf(m);
            return renderMilestone(m, true, cardHeight, index);
        }).join('')
        : '<p class="text-sm text-gray-500">No milestones scheduled</p>';
    
    document.getElementById('nextMonthMilestones').innerHTML = nextMonthMilestones.length > 0
        ? nextMonthMilestones.map(m => {
            const index = allMilestonesFlat.indexOf(m);
            return renderMilestone(m, true, cardHeight, index);
        }).join('')
        : '<p class="text-sm text-gray-500">No milestones scheduled</p>';
}

// Update cards per column setting
function updateCardsPerColumn() {
    const select = document.getElementById('cardsPerColumn');
    const value = select.value;
    console.log('Cards per column changed to:', value);
    localStorage.setItem('milestonesCardsPerColumn', value);
    populateMonthView();
}

// Populate status view (quadrant view)
function populateStatusView() {
    // Build flat array for editing with indices
    allMilestonesFlat = [
        ...allMilestones.completed_past,
        ...allMilestones.open,
        ...allMilestones.upcoming_future,
        ...allMilestones.delayed
    ];
    
    let offset = 0;
    
    // Completed Past quadrant
    document.getElementById('completedPastContainer').innerHTML = allMilestones.completed_past.length > 0
        ? allMilestones.completed_past.map((m, idx) => renderMilestoneCard(m, 'green', offset + idx)).join('')
        : '<p class="text-sm text-gray-500">No completed milestones</p>';
    
    offset += allMilestones.completed_past.length;
    
    // Open quadrant
    document.getElementById('openContainer').innerHTML = allMilestones.open.length > 0
        ? allMilestones.open.map((m, idx) => renderMilestoneCard(m, 'gray', offset + idx)).join('')
        : '<p class="text-sm text-gray-500">No open milestones</p>';
    
    offset += allMilestones.open.length;
    
    // At Risk quadrant
    document.getElementById('atRiskContainer').innerHTML = allMilestones.upcoming_future.length > 0
        ? allMilestones.upcoming_future.map((m, idx) => renderMilestoneCard(m, 'yellow', offset + idx)).join('')
        : '<p class="text-sm text-gray-500">No at-risk milestones</p>';
    
    offset += allMilestones.upcoming_future.length;
    
    // Past Due quadrant
    document.getElementById('pastDueContainer').innerHTML = allMilestones.delayed.length > 0
        ? allMilestones.delayed.map((m, idx) => renderMilestoneCard(m, 'red', offset + idx)).join('')
        : '<p class="text-sm text-gray-500">No past due milestones</p>';
    
    // Update counts in headers
    document.getElementById('completedCount').textContent = allMilestones.completed_past.length;
    document.getElementById('openCount').textContent = allMilestones.open.length;
    document.getElementById('atRiskCount').textContent = allMilestones.upcoming_future.length;
    document.getElementById('pastDueCount').textContent = allMilestones.delayed.length;
}

// Render milestone card for status view
function renderMilestoneCard(milestone, color, milestoneIndex = -1) {
    let html = `
        <div class="border-l-4 border-${color}-500 bg-${color}-50 p-3 rounded overflow-hidden min-h-[140px] cursor-pointer hover:shadow-md transition-shadow" onclick="editMilestone(${milestoneIndex})">
            <p class="font-semibold text-gray-800 truncate" title="${milestone.name}">${milestone.name}</p>`;
    
    if (milestone.parent_project) {
        html += `<p class="text-xs text-gray-500 truncate" title="${milestone.parent_project}">üìÇ ${milestone.parent_project}</p>`;
    }
    
    html += `<p class="text-xs text-gray-500">Target: ${milestone.target_date}</p>`;
    
    if (milestone.resources) {
        html += `<p class="text-xs text-gray-600 mt-1 truncate" title="${milestone.resources}">üë§ ${milestone.resources}</p>`;
    }
    
    if (milestone.completion_percentage) {
        html += `
            <div class="mt-2">
                <div class="w-full bg-gray-200 rounded-full h-1.5">
                    <div class="bg-${color}-500 h-1.5 rounded-full" style="width: ${milestone.completion_percentage}%"></div>
                </div>
            </div>`;
    }
    
    html += '</div>';
    return html;
}

// Switch view function
function switchView(view) {
    const statusView = document.getElementById('statusView');
    const weekView = document.getElementById('weekView');
    const monthView = document.getElementById('monthView');
    const cardsPerColumnControl = document.getElementById('cardsPerColumnControl');
    
    const statusBtn = document.getElementById('statusViewBtn');
    const weekBtn = document.getElementById('weekViewBtn');
    const monthBtn = document.getElementById('monthViewBtn');
    
    // Save current view to localStorage
    localStorage.setItem('currentMilestoneView', view);
    
    // Hide all views and controls
    statusView.classList.add('hidden');
    weekView.classList.add('hidden');
    monthView.classList.add('hidden');
    cardsPerColumnControl.classList.add('hidden');
    cardsPerColumnControl.classList.remove('flex');
    
    // Reset button styles
    const inactiveClass = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition';
    const activeClass = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition';
    
    statusBtn.className = inactiveClass;
    weekBtn.className = inactiveClass;
    monthBtn.className = inactiveClass;
    
    // Show cards per column control for all views
    cardsPerColumnControl.classList.remove('hidden');
    cardsPerColumnControl.classList.add('flex');
    
    // Show selected view
    if (view === 'status') {
        populateStatusView();
        statusView.classList.remove('hidden');
        statusBtn.className = activeClass;
    } else if (view === 'week') {
        populateWeekView();
        weekView.classList.remove('hidden');
        weekBtn.className = activeClass;
    } else if (view === 'month') {
        populateMonthView();
        monthView.classList.remove('hidden');
        monthBtn.className = activeClass;
    }
}

// Notification functions
function showNotification(type, title, message, details = null) {
    const modal = document.getElementById('notificationModal');
    const content = document.getElementById('notificationContent');
    
    const isError = type === 'error';
    const iconColor = isError ? 'red' : 'green';
    const bgColor = isError ? 'red' : 'green';
    const icon = isError 
        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
    
    content.innerHTML = `
        <div class="p-6">
            <div class="flex items-start mb-4">
                <div class="flex-shrink-0">
                    <svg class="h-12 w-12 text-${iconColor}-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${icon}
                    </svg>
                </div>
                <div class="ml-4 flex-1">
                    <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                    <p class="mt-2 text-sm text-gray-600">${message}</p>
                    ${details ? `<p class="mt-2 text-xs text-gray-500">${details}</p>` : ''}
                </div>
            </div>
            
            <div class="bg-${bgColor}-50 border-l-4 border-${bgColor}-500 p-4 mb-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-${bgColor}-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-sm text-${bgColor}-800">
                        ${isError ? 'Please try refreshing the page or re-uploading your XML file.' : 'Your changes have been saved successfully.'}
                    </span>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button onclick="closeNotification()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                    OK
                </button>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

function closeNotification() {
    document.getElementById('notificationModal').classList.add('hidden');
}

// Milestone editing functions
let allMilestonesFlat = [];

function editMilestone(index) {
    if (index < 0 || index >= allMilestonesFlat.length) return;
    
    const milestone = allMilestonesFlat[index];
    
    // Populate form
    document.getElementById('milestoneIndex').value = index;
    document.getElementById('milestoneName').value = milestone.name;
    document.getElementById('milestoneTargetDate').value = milestone.target_date;
    document.getElementById('milestoneStatus').value = milestone.status;
    document.getElementById('milestoneResources').value = milestone.resources || '';
    document.getElementById('milestoneCompletion').value = milestone.completion_percentage || 0;
    
    // Show modal
    document.getElementById('editMilestoneModal').classList.remove('hidden');
}

function closeMilestoneModal() {
    document.getElementById('editMilestoneModal').classList.add('hidden');
}

// Handle form submission
document.getElementById('editMilestoneForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const index = parseInt(document.getElementById('milestoneIndex').value);
    const milestone = allMilestonesFlat[index];
    
    console.log('Original milestone from array:', milestone);
    console.log('Original milestone name:', milestone.name);
    
    const updatedMilestone = {
        ...milestone,
        name: document.getElementById('milestoneName').value,
        target_date: document.getElementById('milestoneTargetDate').value,
        status: document.getElementById('milestoneStatus').value,
        resources: document.getElementById('milestoneResources').value,
        completion_percentage: parseInt(document.getElementById('milestoneCompletion').value) || 0
    };
    
    console.log('Updated milestone to send:', updatedMilestone);
    console.log('Project code being used:', milestone.project);
    
    // Check if milestone has project field
    if (!milestone.project) {
        closeMilestoneModal();
        showNotification(
            'error',
            'Missing Project Information',
            'This milestone is missing project information.',
            'Please refresh the page or re-upload your XML file to fix this issue.'
        );
        return;
    }
    
    // Check if project looks like a filename instead of a code (legacy data)
    if (milestone.project.includes('.xml') || milestone.project.includes(' ')) {
        closeMilestoneModal();
        showNotification(
            'error',
            'Outdated Project Information',
            `Project field contains "${milestone.project.substring(0, 50)}..." which appears to be a filename rather than a project code.`,
            'Please refresh the page to reload the data. If the issue persists, re-upload your XML file.'
        );
        return;
    }
    
    console.log('Updating milestone with project code:', milestone.project);
    
    try {
        const response = await fetch(`/milestones/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                project_code: milestone.project,
                milestone: updatedMilestone
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            closeMilestoneModal();
            showNotification(
                'success',
                'Milestone Updated Successfully!',
                `"${updatedMilestone.name}" has been updated with the latest changes.`
            );
            // Reload after a brief delay to show the success message
            setTimeout(() => window.location.reload(), 1500);
        } else {
            closeMilestoneModal();
            showNotification(
                'error',
                'Error Updating Milestone',
                data.detail || 'An unexpected error occurred while updating the milestone.',
                'Please try again or contact support if the problem persists.'
            );
        }
    } catch (error) {
        closeMilestoneModal();
        showNotification(
            'error',
            'Network Error',
            'Unable to connect to the server.',
            `Error: ${error.message}`
        );
    }
});

// Initialize view on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load saved cards per column preference (default to Normal view)
    const savedLimit = localStorage.getItem('milestonesCardsPerColumn') || '-1';
    document.getElementById('cardsPerColumn').value = savedLimit;
    
    // Update page title with program name
    const selectedProgram = localStorage.getItem('selectedProgram');
    if (selectedProgram) {
        // Remove file extension and clean up the name
        const cleanName = selectedProgram.replace(/\.(xml|XML)$/, '').trim();
        document.getElementById('milestonePageTitle').textContent = `üìç ${cleanName} - Milestone Tracker`;
        document.getElementById('milestonePageSubtitle').textContent = `Milestones organized by status and timeline`;
    }
    
    // Restore saved view or default to status view
    const savedView = localStorage.getItem('currentMilestoneView') || 'status';
    switchView(savedView);
});
</script>
{% endblock %}
