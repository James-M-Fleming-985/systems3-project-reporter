{% extends "base.html" %}

{% block title %}Upload Data - Systems¬≥ Project Reporter{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">üì§ Upload Data</h2>
    <p class="text-gray-600">Upload project XML files and risk data to update your dashboard</p>
</div>

<!-- Upload Cards -->
<div class="grid md:grid-cols-3 gap-6">
    <!-- Project Data Upload Card -->
    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center mb-4">
            <svg class="w-12 h-12 text-blue-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <div>
                <h3 class="text-xl font-bold text-gray-800">Project Data</h3>
                <p class="text-sm text-gray-600">MS Project XML files</p>
            </div>
        </div>
        
        <p class="text-gray-700 mb-4">
            Upload Microsoft Project XML files to track milestones, timelines, and project progress.
        </p>
        
        <ul class="text-sm text-gray-600 mb-4 space-y-1">
            <li>‚úì Automatic change detection</li>
            <li>‚úì Milestone tracking</li>
            <li>‚úì Gantt chart generation</li>
            <li>‚úì Weekly update comparison</li>
        </ul>
        
        <button onclick="openProjectUploadModal()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
            Upload Project XML
        </button>
    </div>

    <!-- Risk Data Upload Card -->
    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center mb-4">
            <svg class="w-12 h-12 text-red-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
                <h3 class="text-xl font-bold text-gray-800">Risk Data</h3>
                <p class="text-sm text-gray-600">Excel, CSV, or YAML files</p>
            </div>
        </div>
        
        <p class="text-gray-700 mb-4">
            Upload risk registers to calculate risk scores and visualize risk distribution.
        </p>
        
        <ul class="text-sm text-gray-600 mb-4 space-y-1">
            <li>‚úì YAML, Excel, or CSV formats</li>
            <li>‚úì Automatic severity calculation</li>
            <li>‚úì Risk score metrics</li>
            <li>‚úì Distribution charts</li>
        </ul>
        
        <button onclick="openRiskUploadModal()" class="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold">
            Upload Risk Data
        </button>
    </div>

    <!-- Metrics Data Upload Card -->
    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center mb-4">
            <svg class="w-12 h-12 text-green-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <div>
                <h3 class="text-xl font-bold text-gray-800">Metrics Data</h3>
                <p class="text-sm text-gray-600">CSV or Excel files</p>
            </div>
        </div>
        
        <p class="text-gray-700 mb-4">
            Import historical custom metric data from CSV or Excel files with optional annotations.
        </p>
        
        <ul class="text-sm text-gray-600 mb-4 space-y-1">
            <li>‚úì CSV and Excel formats</li>
            <li>‚úì Field mapping interface</li>
            <li>‚úì Annotation/callout support</li>
            <li>‚úì Bulk historical import</li>
        </ul>
        
        <button id="uploadMetricsBtn" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
            üìä Upload Metrics Data
        </button>
    </div>
</div>

<!-- PowerPoint Template Upload Card -->
<div class="grid grid-cols-1 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-md p-8 border-l-4 border-purple-500">
        <div class="flex items-start mb-4">
            <div class="bg-purple-100 rounded-lg p-3 mr-4">
                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <div class="flex-1">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">PowerPoint Templates</h2>
                <p class="text-gray-600">Custom .pptx templates with organization branding</p>
            </div>
        </div>
        
        <p class="text-gray-700 mb-4">
            Upload custom PowerPoint templates with your organization's logos, colors, and branding for professional reports.
        </p>
        
        <ul class="text-sm text-gray-600 mb-4 space-y-1">
            <li>‚úì Custom layouts and branding</li>
            <li>‚úì Set default templates</li>
            <li>‚úì Multiple template support</li>
            <li>‚úì Professional branded exports</li>
        </ul>
        
        <button id="openTemplatePanelBtn" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold">
            üì§ Manage PowerPoint Templates
        </button>
    </div>
</div>

<!-- Recent Uploads -->
<div class="mt-8 bg-white rounded-lg shadow-md p-6">
    <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Recent Uploads</h3>
    <div id="recentUploads" class="text-gray-600">
        <p class="text-center py-8">No recent uploads</p>
    </div>
</div>

<!-- Template Management Modal -->
<div id="templateManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">PowerPoint Template Management</h3>
                <button onclick="closeTemplateModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Drop Zone -->
            <div id="templateDropZoneUnified" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 cursor-pointer hover:border-purple-500 transition-colors">
                <svg class="mx-auto h-10 w-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mt-3 text-gray-600">Drop PowerPoint template here or click to browse</p>
                <p class="text-sm text-gray-500 mt-1">Accepts .pptx files with custom layouts and branding</p>
                <input type="file" id="templateFileInputUnified" accept=".pptx" class="hidden">
            </div>
            
            <div id="templateFileInfoUnified" class="hidden bg-purple-50 border border-purple-200 rounded p-4 mb-4">
                <p class="text-sm text-purple-800"><strong>Selected template:</strong> <span id="templateFileNameUnified"></span></p>
                <input type="text" id="templateNameInputUnified" placeholder="Template name (e.g., Q4 2025 Branding)" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>
            
            <!-- Success Message -->
            <div id="templateUploadSuccess" class="hidden bg-green-50 border border-green-200 rounded p-4 mb-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-green-800 font-semibold">Template uploaded successfully!</span>
                </div>
                <p class="text-sm text-green-700 mt-2" id="templateUploadSuccessMessage"></p>
            </div>
            
            <!-- Error Message -->
            <div id="templateUploadError" class="hidden bg-red-50 border border-red-200 rounded p-4 mb-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-red-800 font-semibold">Upload failed</span>
                </div>
                <p class="text-sm text-red-700 mt-2" id="templateUploadErrorMessage"></p>
            </div>
            
            <button id="uploadTemplateBtnUnified" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors mb-6" disabled>
                üì§ Upload Template
            </button>
            
            <!-- Existing Templates List -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold mb-3">Available Templates</h3>
                <div id="templatesContainerUnified" class="space-y-2">
                    <p class="text-sm text-gray-500">Loading templates...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Template Confirmation Modal -->
<div id="deleteTemplateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <svg class="h-12 w-12 text-red-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Delete Template</h3>
                    <p class="text-sm text-gray-600 mt-1">This action cannot be undone</p>
                </div>
            </div>
            <p class="text-gray-700 mb-6">Are you sure you want to delete <strong id="deleteTemplateName"></strong>?</p>
            <div class="flex gap-3">
                <button onclick="cancelDeleteTemplate()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold">
                    Cancel
                </button>
                <button onclick="confirmDeleteTemplate()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                    Delete Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Project Upload Modal -->
<div id="projectUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">Upload Project XML</h3>
                <button onclick="closeProjectUploadModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Drop Zone -->
            <div id="projectDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center mb-4 cursor-pointer hover:border-blue-500 transition-colors">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-4 text-lg text-gray-600">Drag and drop MS Project XML file</p>
                <p class="text-sm text-gray-500 mt-2">or click to browse</p>
                <input type="file" id="projectFileInput" accept=".xml" class="hidden">
            </div>
            
            <div id="projectFileInfo" class="hidden bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                <p class="text-sm text-blue-800"><strong>Selected:</strong> <span id="projectFileName"></span></p>
                <p class="text-sm text-blue-600 mt-1" id="projectFileSize"></p>
            </div>
            
            <!-- Baseline Option -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-start">
                    <input type="checkbox" id="projectBaselineCheckbox" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1">
                    <label for="projectBaselineCheckbox" class="ml-3 text-sm text-gray-700">
                        <span class="font-semibold">Set as Baseline</span>
                        <p class="text-gray-600 mt-1">Skip change detection and establish this as the new baseline for future comparisons.</p>
                    </label>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <button onclick="clearProjectCache()" class="text-sm text-red-600 hover:text-red-800 font-semibold">
                        üóëÔ∏è Clear Cached Project Data
                    </button>
                    <p class="text-xs text-gray-500 mt-1">Use this if changes aren't being detected. Next upload will be treated as baseline.</p>
                </div>
            </div>
            
            <!-- Progress -->
            <div id="projectProgress" class="hidden bg-blue-50 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <svg class="animate-spin h-5 w-5 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-700">Processing XML file...</span>
                </div>
            </div>
            
            <!-- Success Message -->
            <div id="projectSuccess" class="hidden bg-green-50 border border-green-200 rounded p-4 mb-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-green-800 font-semibold">Upload successful!</span>
                </div>
                <p class="text-sm text-green-700 mt-2" id="projectSuccessMessage"></p>
            </div>
            
            <!-- Error Message -->
            <div id="projectError" class="hidden bg-red-50 border border-red-200 rounded p-4 mb-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-red-800 font-semibold">Upload failed</span>
                </div>
                <p class="text-sm text-red-700 mt-2" id="projectErrorMessage"></p>
            </div>
            
            <button id="projectUploadBtn" onclick="uploadProjectFile()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-semibold" disabled>
                Upload Project XML
            </button>
        </div>
    </div>
</div>

<!-- Risk Upload Modal -->
<div id="riskUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">Upload Risk Data</h3>
                <button onclick="closeRiskUploadModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Program Selection -->
            <div class="mb-4">
                <label for="riskProgramSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                    Select Program <span class="text-red-500">*</span>
                </label>
                <select id="riskProgramSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    <option value="">-- Select a program --</option>
                </select>
                <p class="text-xs text-gray-600 mt-1">Select the program these risks belong to</p>
            </div>
            
            <!-- Drop Zone -->
            <div id="riskDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center mb-4 cursor-pointer hover:border-red-500 transition-colors">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-4 text-lg text-gray-600">Drag and drop risk file</p>
                <p class="text-sm text-gray-500 mt-2">YAML (.yaml, .yml), Excel (.xlsx, .xls), or CSV (.csv)</p>
                <input type="file" id="riskFileInput" accept=".yaml,.yml,.xlsx,.xls,.csv" class="hidden">
            </div>
            
            <div id="riskFileInfo" class="hidden bg-red-50 border border-red-200 rounded p-4 mb-4">
                <p class="text-sm text-red-800"><strong>Selected:</strong> <span id="riskFileName"></span></p>
                <p class="text-sm text-red-600 mt-1" id="riskFileSize"></p>
            </div>
            
            <!-- Format Examples -->
            <details class="mb-4 p-4 bg-gray-50 rounded-lg">
                <summary class="cursor-pointer font-semibold text-gray-700">üìã File Format Examples</summary>
                <div class="mt-4 space-y-4 text-sm">
                    <div>
                        <p class="font-semibold text-gray-800 mb-2">YAML Format:</p>
                        <pre class="bg-gray-800 text-green-400 p-3 rounded overflow-x-auto"><code>risks:
  - id: R001
    title: "Supply chain disruption"
    description: "Potential delays from supplier"
    likelihood: high  # or: low, medium, high, critical
    impact: high
    mitigations: "Identify backup suppliers"
    owner: "John Doe"
    date_identified: "2025-01-15"
    status: open</code></pre>
                    </div>
                    
                    <div>
                        <p class="font-semibold text-gray-800 mb-2">Excel/CSV Columns:</p>
                        <pre class="bg-gray-800 text-green-400 p-3 rounded overflow-x-auto"><code>ID | Title | Description | Likelihood | Impact | Mitigations | Owner | Date Identified | Status</code></pre>
                        <p class="text-gray-600 mt-2">Column names are flexible (case-insensitive)</p>
                    </div>
                </div>
            </details>
            
            <!-- Progress -->
            <div id="riskProgress" class="hidden bg-red-50 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <svg class="animate-spin h-5 w-5 text-red-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-700">Processing risk file...</span>
                </div>
            </div>
            
            <!-- Success Message -->
            <div id="riskSuccess" class="hidden bg-green-50 border border-green-200 rounded p-4 mb-4">
                <div class="flex items-center mb-2">
                    <svg class="h-5 w-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-green-800 font-semibold">Upload successful!</span>
                </div>
                <div id="riskSuccessDetails" class="text-sm text-green-700 ml-8"></div>
            </div>
            
            <!-- Error Message -->
            <div id="riskError" class="hidden bg-red-50 border border-red-200 rounded p-4 mb-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-red-800 font-semibold">Upload failed</span>
                </div>
                <p class="text-sm text-red-700 mt-2" id="riskErrorMessage"></p>
            </div>
            
            <button id="riskUploadBtn" onclick="uploadRiskFile()" class="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-semibold" disabled>
                Upload Risk Data
            </button>
        </div>
    </div>
</div>

<script>
// Modal functions
function openProjectUploadModal() {
    document.getElementById('projectUploadModal').classList.remove('hidden');
}

function closeProjectUploadModal() {
    document.getElementById('projectUploadModal').classList.add('hidden');
    resetProjectUpload();
}

function openRiskUploadModal() {
    document.getElementById('riskUploadModal').classList.remove('hidden');
    populateProgramDropdown(); // Load available programs
}

function closeRiskUploadModal() {
    document.getElementById('riskUploadModal').classList.add('hidden');
    resetRiskUpload();
}

// Project Upload Logic
let projectFile = null;

const projectDropZone = document.getElementById('projectDropZone');
const projectFileInput = document.getElementById('projectFileInput');

projectDropZone.addEventListener('click', () => projectFileInput.click());

projectDropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    projectDropZone.classList.add('border-blue-500', 'bg-blue-50');
});

projectDropZone.addEventListener('dragleave', () => {
    projectDropZone.classList.remove('border-blue-500', 'bg-blue-50');
});

projectDropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    projectDropZone.classList.remove('border-blue-500', 'bg-blue-50');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleProjectFile(files[0]);
    }
});

projectFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleProjectFile(e.target.files[0]);
    }
});

function handleProjectFile(file) {
    if (!file.name.endsWith('.xml')) {
        alert('Please select an XML file');
        return;
    }
    
    projectFile = file;
    document.getElementById('projectFileName').textContent = file.name;
    document.getElementById('projectFileSize').textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
    document.getElementById('projectFileInfo').classList.remove('hidden');
    document.getElementById('projectUploadBtn').disabled = false;
}

async function uploadProjectFile() {
    if (!projectFile) return;
    
    const formData = new FormData();
    formData.append('file', projectFile);
    
    const isBaseline = document.getElementById('projectBaselineCheckbox').checked;
    if (isBaseline) {
        formData.append('baseline', 'true');
    }
    
    // Hide previous messages
    document.getElementById('projectSuccess').classList.add('hidden');
    document.getElementById('projectError').classList.add('hidden');
    
    // Show progress
    document.getElementById('projectProgress').classList.remove('hidden');
    document.getElementById('projectUploadBtn').disabled = true;
    
    try {
        const response = await fetch('/upload/xml', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        document.getElementById('projectProgress').classList.add('hidden');
        
        if (response.ok) {
            document.getElementById('projectSuccess').classList.remove('hidden');
            document.getElementById('projectSuccessMessage').textContent = 
                `${data.project_name} uploaded successfully! ${data.milestone_count || 0} milestones loaded. Redirecting to dashboard...`;
            
            // Store the newly uploaded project in localStorage so dashboard selects it
            localStorage.setItem('selectedProgram', data.project_name);
            localStorage.setItem('selectedProjectCode', data.project_code);
            
            // Redirect to gantt with project parameter after 2 seconds
            setTimeout(() => {
                window.location.href = `/dashboard/gantt?project=${encodeURIComponent(data.project_code)}`;
            }, 2000);
        } else {
            throw new Error(data.detail || 'Upload failed');
        }
    } catch (error) {
        document.getElementById('projectProgress').classList.add('hidden');
        document.getElementById('projectError').classList.remove('hidden');
        document.getElementById('projectErrorMessage').textContent = error.message;
        document.getElementById('projectUploadBtn').disabled = false;
    }
}

function resetProjectUpload() {
    projectFile = null;
    document.getElementById('projectFileInfo').classList.add('hidden');
    document.getElementById('projectSuccess').classList.add('hidden');
    document.getElementById('projectError').classList.add('hidden');
    document.getElementById('projectProgress').classList.add('hidden');
    document.getElementById('projectUploadBtn').disabled = true;
    document.getElementById('projectBaselineCheckbox').checked = false;
    projectFileInput.value = '';
}

async function clearProjectCache() {
    // Get selected project from localStorage or prompt user
    const selectedProgram = localStorage.getItem('selectedProgram');
    
    if (!selectedProgram) {
        alert('Please select a project from the dashboard first');
        return;
    }
    
    if (!confirm(`Clear cached data for ${selectedProgram}?\n\nThis will delete all saved milestone and change data. Your next upload will be treated as a baseline.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/upload/clear-cache/${selectedProgram}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ ${result.message}`);
        } else {
            alert(`‚ùå ${result.message || result.error}`);
        }
    } catch (error) {
        alert(`‚ùå Failed to clear cache: ${error.message}`);
    }
}

// Risk Upload Logic
let riskFile = null;

const riskDropZone = document.getElementById('riskDropZone');
const riskFileInput = document.getElementById('riskFileInput');
const riskProgramSelect = document.getElementById('riskProgramSelect');

// Populate program dropdown on modal open
async function populateProgramDropdown() {
    try {
        // Get currently selected program from localStorage
        const selectedProgram = localStorage.getItem('selectedProgram');
        
        // Fetch all projects
        const response = await fetch('/dashboard/api/projects');
        if (!response.ok) {
            console.error('Failed to fetch projects');
            return;
        }
        
        const projects = await response.json();
        
        // Clear existing options (except first)
        riskProgramSelect.innerHTML = '<option value="">-- Select a program --</option>';
        
        // Add project options
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.name;
            option.textContent = project.name;
            
            // Pre-select if it matches localStorage
            if (selectedProgram && project.name === selectedProgram) {
                option.selected = true;
            }
            
            riskProgramSelect.appendChild(option);
        });
        
        // Update upload button state
        updateRiskUploadButton();
    } catch (error) {
        console.error('Error populating programs:', error);
    }
}

riskDropZone.addEventListener('click', () => riskFileInput.click());

riskDropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    riskDropZone.classList.add('border-red-500', 'bg-red-50');
});

riskDropZone.addEventListener('dragleave', () => {
    riskDropZone.classList.remove('border-red-500', 'bg-red-50');
});

riskDropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    riskDropZone.classList.remove('border-red-500', 'bg-red-50');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleRiskFile(files[0]);
    }
});

riskFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleRiskFile(e.target.files[0]);
    }
});

riskProgramSelect.addEventListener('change', updateRiskUploadButton);

function handleRiskFile(file) {
    const validExtensions = ['.yaml', '.yml', '.xlsx', '.xls', '.csv'];
    const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
    
    if (!validExtensions.includes(fileExt)) {
        alert('Please select a YAML, Excel, or CSV file');
        return;
    }
    
    riskFile = file;
    document.getElementById('riskFileName').textContent = file.name;
    document.getElementById('riskFileSize').textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
    document.getElementById('riskFileInfo').classList.remove('hidden');
    updateRiskUploadButton();
}

function updateRiskUploadButton() {
    const hasFile = riskFile !== null;
    const hasProgram = riskProgramSelect.value.trim() !== '';
    document.getElementById('riskUploadBtn').disabled = !(hasFile && hasProgram);
}

async function uploadRiskFile() {
    if (!riskFile || !riskProgramSelect.value.trim()) return;
    
    const formData = new FormData();
    formData.append('file', riskFile);
    formData.append('program_name', riskProgramSelect.value.trim());
    
    // Hide previous messages
    document.getElementById('riskSuccess').classList.add('hidden');
    document.getElementById('riskError').classList.add('hidden');
    
    // Show progress
    document.getElementById('riskProgress').classList.remove('hidden');
    document.getElementById('riskUploadBtn').disabled = true;
    
    try {
        const response = await fetch('/risks/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        document.getElementById('riskProgress').classList.add('hidden');
        
        if (response.ok && data.success) {
            document.getElementById('riskSuccess').classList.remove('hidden');
            const details = `
                <p>Program: <strong>${data.program_name}</strong></p>
                <p>Total Risks: <strong>${data.risk_count}</strong></p>
                <p>Critical: ${data.severity_counts.critical} | High: ${data.severity_counts.high} | Medium: ${data.severity_counts.medium} | Low: ${data.severity_counts.low}</p>
            `;
            document.getElementById('riskSuccessDetails').innerHTML = details;
            
            // Redirect to risks page after 2 seconds
            setTimeout(() => {
                window.location.href = '/dashboard/risks';
            }, 2000);
        } else {
            throw new Error(data.detail || data.message || 'Upload failed');
        }
    } catch (error) {
        document.getElementById('riskProgress').classList.add('hidden');
        document.getElementById('riskError').classList.remove('hidden');
        document.getElementById('riskErrorMessage').textContent = error.message;
        document.getElementById('riskUploadBtn').disabled = false;
    }
}

function resetRiskUpload() {
    riskFile = null;
    document.getElementById('riskFileInfo').classList.add('hidden');
    document.getElementById('riskSuccess').classList.add('hidden');
    document.getElementById('riskError').classList.add('hidden');
    document.getElementById('riskProgress').classList.add('hidden');
    document.getElementById('riskUploadBtn').disabled = true;
    document.getElementById('riskProgramSelect').value = '';
    riskFileInput.value = '';
}

// Close modals on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeProjectUploadModal();
        closeRiskUploadModal();
        closeMetricsUploadModal();
    }
});

// ==================== METRICS UPLOAD FUNCTIONALITY ====================
console.log('Initializing metrics upload...');

// Notification function
function showNotification(title, message, type = 'info') {
    const colors = {
        success: 'bg-green-100 border-green-500 text-green-800',
        error: 'bg-red-100 border-red-500 text-red-800',
        warning: 'bg-yellow-100 border-yellow-500 text-yellow-800',
        info: 'bg-blue-100 border-blue-500 text-blue-800'
    };
    
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 max-w-md p-4 border-l-4 rounded shadow-lg ' + (colors[type] || colors.info);
    notification.innerHTML = '<div class="font-bold mb-1">' + title + '</div><div class="text-sm whitespace-pre-line">' + message + '</div>';
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transition = 'opacity 0.3s';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

const uploadMetricsBtn = document.getElementById('uploadMetricsBtn');
console.log('Upload metrics button found:', uploadMetricsBtn);
let metricsUploadModal = null;
let parsedFileData = null;
let programName = localStorage.getItem('selectedProgram') || '';
console.log('Selected program:', programName);

// Do NOT clean the program name - use it exactly as stored to match the metrics page
console.log('Using program name for storage key:', programName);

if (uploadMetricsBtn) {
    console.log('Adding click listener to metrics upload button');
    uploadMetricsBtn.addEventListener('click', showMetricsUploadModal);
} else {
    console.error('Upload metrics button NOT found in DOM!');
}

function showMetricsUploadModal() {
    if (!programName) {
        showNotification('No Program Selected', 'Please select a program from the dashboard before uploading metrics data.', 'error');
        return;
    }

    metricsUploadModal = document.createElement('div');
    metricsUploadModal.id = 'metricsUploadModal';
    metricsUploadModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    metricsUploadModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">Upload Metric Historical Data</h3>
                    <button onclick="closeMetricsUploadModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-2">Upload CSV or Excel file with historical metric data including metric name, date, value, and optional annotations.</p>
            </div>
            
            <div class="p-6">
                <!-- Success Message -->
                <div id="metricsSuccess" class="hidden bg-green-50 border border-green-200 rounded p-4 mb-4">
                    <div class="flex items-center mb-2">
                        <svg class="h-5 w-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-green-800 font-semibold">Upload successful!</span>
                    </div>
                    <div id="metricsSuccessMessage" class="text-sm text-green-700 ml-8"></div>
                </div>
                
                <!-- Error Message -->
                <div id="metricsError" class="hidden bg-red-50 border border-red-200 rounded p-4 mb-4">
                    <div class="flex items-center mb-2">
                        <svg class="h-5 w-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-red-800 font-semibold">Upload failed</span>
                    </div>
                    <div id="metricsErrorMessage" class="text-sm text-red-700 ml-8"></div>
                </div>
                
                <!-- Warning Message -->
                <div id="metricsWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                    <div class="flex items-center mb-2">
                        <svg class="h-5 w-5 text-yellow-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <span class="text-yellow-800 font-semibold">No data imported</span>
                    </div>
                    <div id="metricsWarningMessage" class="text-sm text-yellow-700 ml-8"></div>
                </div>
                
                <!-- Step 1: File Upload -->
                <div id="metricsUploadStep1">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select File (CSV or Excel)</label>
                        <input type="file" id="metricsFileInput" accept=".csv,.xlsx,.xls" 
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                        <p class="text-xs text-gray-500 mt-1">Supported formats: CSV, Excel (.xlsx, .xls)</p>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button onclick="closeMetricsUploadModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                            Cancel
                        </button>
                        <button id="parseMetricsFileBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                            Next: Map Fields
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Field Mapping -->
                <div id="metricsUploadStep2" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                        <p class="text-sm text-blue-800"><strong>Preview:</strong> First 5 rows from your file</p>
                    </div>
                    <div class="overflow-x-auto mb-4">
                        <table class="min-w-full divide-y divide-gray-200 border">
                            <thead id="metricsPreviewTableHead" class="bg-gray-50"></thead>
                            <tbody id="metricsPreviewTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                        <p class="text-sm text-yellow-800 mb-3"><strong>Map your columns to metric fields:</strong></p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Metric Name Column *</label>
                                <select id="mapMetricName" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date Column *</label>
                                <select id="mapDate" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Value Columns * (Select one or more)</label>
                                <div id="valueColumnsContainer" class="border border-gray-300 rounded p-3 bg-white max-h-40 overflow-y-auto">
                                    <p class="text-xs text-gray-500">Columns will appear here after file is loaded</p>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    Tip: Select multiple columns to create multiple trend lines on the same chart
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Annotation/Callout Column (Optional)</label>
                                <select id="mapAnnotation" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="">-- None --</option>
                                </select>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">* Required fields</p>
                    </div>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded p-4 mb-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="overwriteDuplicates" class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            <span class="ml-2 text-sm text-gray-700">
                                <strong>Overwrite existing data</strong> - Replace values for dates that already exist (default: skip duplicates)
                            </span>
                        </label>
                    </div>
                    
                    <div class="flex justify-end gap-3">
                        <button id="backToMetricsUploadBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                            Back
                        </button>
                        <button id="importMetricsDataBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                            Import Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(metricsUploadModal);

    // Attach event listeners
    document.getElementById('parseMetricsFileBtn').addEventListener('click', parseMetricsFile);
    document.getElementById('backToMetricsUploadBtn').addEventListener('click', () => {
        document.getElementById('metricsUploadStep1').classList.remove('hidden');
        document.getElementById('metricsUploadStep2').classList.add('hidden');
    });
    document.getElementById('importMetricsDataBtn').addEventListener('click', importMetricsData);
}

function closeMetricsUploadModal() {
    if (metricsUploadModal) {
        metricsUploadModal.remove();
        metricsUploadModal = null;
    }
    parsedFileData = null;
}

async function parseMetricsFile() {
    const fileInput = document.getElementById('metricsFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        document.getElementById('metricsErrorMessage').textContent = 'Please select a file first';
        document.getElementById('metricsError').classList.remove('hidden');
        return;
    }

    // Hide previous messages
    document.getElementById('metricsSuccess').classList.add('hidden');
    document.getElementById('metricsError').classList.add('hidden');
    document.getElementById('metricsWarning').classList.add('hidden');

    try {
        parsedFileData = await parseFile(file);
        showMetricsFieldMapping(parsedFileData);
        document.getElementById('metricsUploadStep1').classList.add('hidden');
        document.getElementById('metricsUploadStep2').classList.remove('hidden');
    } catch (error) {
        document.getElementById('metricsErrorMessage').textContent = 'Error parsing file: ' + error.message;
        document.getElementById('metricsError').classList.remove('hidden');
    }
}

function parseFile(file) {
    return new Promise((resolve, reject) => {
        const fileName = file.name.toLowerCase();
        
        if (fileName.endsWith('.csv')) {
            parseCSV(file).then(resolve).catch(reject);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            parseExcel(file).then(resolve).catch(reject);
        } else {
            reject(new Error('Unsupported file format. Please use CSV or Excel.'));
        }
    });
}

function parseCSV(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const lines = text.split('\\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    reject(new Error('CSV file must have at least a header row and one data row'));
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                const rows = lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = values[i] || '';
                    });
                    return obj;
                });
                
                resolve({ headers, rows });
            } catch (error) {
                reject(new Error('Error parsing CSV file: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('Error reading CSV file'));
        reader.readAsText(file);
    });
}

function parseExcel(file) {
    return new Promise((resolve, reject) => {
        // Load XLSX library dynamically if not already loaded
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            // Try CDN first for better reliability
            script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
            script.onload = () => {
                // Check if library loaded successfully
                if (typeof XLSX === 'undefined') {
                    reject(new Error('Excel parser library failed to load. Please try using CSV format instead.'));
                } else {
                    readExcelFile(file, resolve, reject);
                }
            };
            script.onerror = () => {
                // Try local fallback
                console.log('CDN failed, trying local library...');
                const localScript = document.createElement('script');
                localScript.src = '/static/js/libs/xlsx.full.min.js';
                localScript.onload = () => {
                    if (typeof XLSX === 'undefined') {
                        reject(new Error('Excel parser library failed to load. Please try using CSV format instead.'));
                    } else {
                        readExcelFile(file, resolve, reject);
                    }
                };
                localScript.onerror = () => reject(new Error('Failed to load Excel parser library. Please use CSV format instead.'));
                document.head.appendChild(localScript);
            };
            document.head.appendChild(script);
        } else {
            readExcelFile(file, resolve, reject);
        }
    });
}

function readExcelFile(file, resolve, reject) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            if (jsonData.length < 2) {
                reject(new Error('Excel file must have at least a header row and one data row'));
                return;
            }
            
            const headers = jsonData[0];
            const rows = jsonData.slice(1).map(row => {
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = row[i] !== undefined ? String(row[i]) : '';
                });
                return obj;
            });
            
            resolve({ headers, rows });
        } catch (error) {
            reject(new Error('Error parsing Excel file: ' + error.message));
        }
    };
    reader.onerror = () => reject(new Error('Error reading Excel file'));
    reader.readAsArrayBuffer(file);
}

function showMetricsFieldMapping(data) {
    const { headers, rows } = data;
    
    // Helper function to format cell values (especially dates)
    function formatCellValue(value) {
        if (!value) return '';
        
        // Check if it's an Excel serial date
        const numVal = parseFloat(value);
        if (!isNaN(numVal) && numVal > 100 && numVal < 100000) {
            const excelEpoch = new Date(1899, 11, 30);
            const date = new Date(excelEpoch.getTime() + numVal * 86400000);
            if (!isNaN(date.getTime())) {
                return date.toLocaleDateString('en-GB'); // dd/mm/yyyy format
            }
        }
        return value;
    }
    
    // Populate preview table
    const thead = document.getElementById('metricsPreviewTableHead');
    const tbody = document.getElementById('metricsPreviewTableBody');
    
    thead.innerHTML = '<tr>' + headers.map(h => '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">' + h + '</th>').join('') + '</tr>';
    
    const previewRows = rows.slice(0, 5);
    tbody.innerHTML = previewRows.map(row => 
        '<tr>' + headers.map(h => '<td class="px-4 py-2 text-sm text-gray-900">' + formatCellValue(row[h]) + '</td>').join('') + '</tr>'
    ).join('');
    
    // Populate mapping dropdowns
    const mapMetricName = document.getElementById('mapMetricName');
    const mapDate = document.getElementById('mapDate');
    const mapAnnotation = document.getElementById('mapAnnotation');
    const valueColumnsContainer = document.getElementById('valueColumnsContainer');
    
    [mapMetricName, mapDate].forEach(select => {
        select.innerHTML = '<option value="">-- Select Column --</option>' + 
            headers.map(h => '<option value="' + h + '">' + h + '</option>').join('');
    });
    
    // Annotation is optional
    mapAnnotation.innerHTML = '<option value="">-- None --</option>' + 
        headers.map(h => '<option value="' + h + '">' + h + '</option>').join('');
    
    // Create checkboxes for value columns with smart detection
    valueColumnsContainer.innerHTML = headers.map(header => {
        // Check if column appears to be numeric by sampling first few rows
        const sampleValues = rows.slice(0, 5).map(r => r[header]).filter(v => v);
        const numericCount = sampleValues.filter(v => !isNaN(parseFloat(v))).length;
        const isLikelyNumeric = numericCount > sampleValues.length / 2;
        
        const badge = isLikelyNumeric 
            ? '<span class="ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded">numeric</span>'
            : '<span class="ml-2 px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded">text</span>';
        
        return `
            <label class="flex items-center py-1 hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" name="valueColumn" value="${header}" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
                <span class="text-sm text-gray-700">${header}</span>
                ${badge}
            </label>
        `;
    }).join('');
    
    // Auto-detect columns
    let autoSelectedValueCol = false;
    headers.forEach(header => {
        const lower = header.toLowerCase();
        
        // Check if this column is numeric
        const sampleValues = rows.slice(0, 5).map(r => r[header]).filter(v => v);
        const numericCount = sampleValues.filter(v => !isNaN(parseFloat(v))).length;
        const isLikelyNumeric = numericCount > sampleValues.length / 2;
        
        if (lower.includes('metric') || lower.includes('name')) {
            mapMetricName.value = header;
        } else if (lower.includes('date') || lower.includes('time') || lower.includes('week')) {
            mapDate.value = header;
        } else if (lower.includes('annotation') || lower.includes('callout') || lower.includes('note') || lower.includes('comment')) {
            mapAnnotation.value = header;
        } else if (!autoSelectedValueCol && isLikelyNumeric && (lower.includes('value') || lower.includes('amount') || lower.includes('score') || lower.includes('count') || lower.includes('part') || lower.includes('complete') || lower.includes('%'))) {
            // Auto-check first numeric value column found
            const checkbox = valueColumnsContainer.querySelector(`input[value="${header}"]`);
            if (checkbox) {
                checkbox.checked = true;
                autoSelectedValueCol = true;
            }
        }
    });
}

function importMetricsData() {
    const metricNameCol = document.getElementById('mapMetricName').value;
    const dateCol = document.getElementById('mapDate').value;
    const annotationCol = document.getElementById('mapAnnotation').value;
    const overwriteDuplicates = document.getElementById('overwriteDuplicates').checked;
    
    // Get all checked value columns
    const valueColumns = Array.from(document.querySelectorAll('input[name="valueColumn"]:checked'))
        .map(cb => cb.value);
    
    // Hide previous messages
    document.getElementById('metricsSuccess').classList.add('hidden');
    document.getElementById('metricsError').classList.add('hidden');
    document.getElementById('metricsWarning').classList.add('hidden');
    
    if (!metricNameCol || !dateCol || valueColumns.length === 0) {
        document.getElementById('metricsErrorMessage').textContent = 'Please select metric name, date, and at least one value column';
        document.getElementById('metricsError').classList.remove('hidden');
        return;
    }
    
    console.log('Import mode:', overwriteDuplicates ? 'OVERWRITE' : 'MERGE (skip duplicates)');
    console.log('Import starting with mappings:', { metricNameCol, dateCol, valueColumns, annotationCol });
    console.log('Parsed file data:', parsedFileData);
    
    const { rows } = parsedFileData;
    console.log('Total rows to process:', rows.length);
    
    // Load existing metrics
    const storageKey = 'customMetrics_' + programName;
    let customMetrics = JSON.parse(localStorage.getItem(storageKey) || '[]');
    console.log('Existing metrics:', customMetrics.length);
    
    let importCount = 0;
    let updateCount = 0;
    let skippedCount = 0;
    const skippedColumns = new Set();  // Track non-numeric columns
    
    rows.forEach((row, idx) => {
        const baseMetricName = row[metricNameCol];
        const dateStr = row[dateCol];
        const annotation = annotationCol ? row[annotationCol] : '';
        
        if (!baseMetricName || !dateStr) {
            console.warn('Skipping row', idx, '- missing metric name or date');
            skippedCount++;
            return;
        }
        
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) {
            console.warn('Skipping - invalid date:', dateStr);
            skippedCount++;
            return;
        }
        
        // Find or create metric (one metric for all value columns)
        let metric = customMetrics.find(m => m.name === baseMetricName);
        
        if (!metric) {
            // Create new metric with series support
            metric = {
                name: baseMetricName,
                value: 0,
                unit: '',
                target: null,
                targetDate: null,
                status: 'ON_TRACK',
                lastUpdated: date.toISOString(),
                series: {},  // Multiple series (one per value column)
                history: []  // Legacy support - will use first series
            };
            customMetrics.push(metric);
            importCount++;
            console.log('Created new metric:', baseMetricName);
        }
        
        // Ensure series object exists
        if (!metric.series) {
            metric.series = {};
        }
        
        // Process each value column as a series
        valueColumns.forEach(valueCol => {
            const valueStr = row[valueCol];
            
            if (!valueStr) {
                console.warn('Skipping value column', valueCol, 'for row', idx, '- missing value');
                return;
            }
            
            const value = parseFloat(valueStr);
            if (isNaN(value)) {
                console.warn('Skipping value column', valueCol, '- invalid numeric value:', valueStr);
                skippedColumns.add(valueCol);
                return;  // Skip this column only, continue with other columns
            }
            
            // Initialize series if it doesn't exist
            if (!metric.series[valueCol]) {
                metric.series[valueCol] = [];
            }
            
            // Check for existing entry on this date in this series
            const existingEntry = metric.series[valueCol].find(h => 
                new Date(h.date).toDateString() === date.toDateString()
            );
            
            if (existingEntry) {
                if (overwriteDuplicates) {
                    // Update existing entry
                    existingEntry.value = value;
                    if (annotation) existingEntry.annotation = annotation;
                    updateCount++;
                    console.log('Updated existing entry for', baseMetricName, '-', valueCol, 'on', dateStr);
                } else {
                    // Skip duplicate
                    console.log('Skipped duplicate for', baseMetricName, '-', valueCol, 'on', dateStr);
                    skippedCount++;
                    return;
                }
            } else {
                // Add new history entry to this series
                metric.series[valueCol].push({
                    value: value,
                    date: date.toISOString(),
                    annotation: annotation || undefined
                });
                updateCount++;
                console.log('Added data point for', baseMetricName, '-', valueCol);
            }
            
            // Update current value to first series' latest value
            if (valueCol === valueColumns[0]) {
                if (new Date(metric.lastUpdated) < date) {
                    metric.value = value;
                    metric.lastUpdated = date.toISOString();
                }
            }
        });
        
        // Update legacy history array for backward compatibility (use first series)
        if (valueColumns.length > 0 && metric.series[valueColumns[0]]) {
            metric.history = metric.series[valueColumns[0]];
        }
    });
    
    // Save metrics
    localStorage.setItem(storageKey, JSON.stringify(customMetrics));
    
    console.log('Import complete - Imported:', importCount, 'Updated:', updateCount, 'Skipped:', skippedCount);
    console.log('Final metrics array:', customMetrics);
    
    // Hide step 2, show result message
    document.getElementById('metricsUploadStep2').classList.add('hidden');
    
    // Show appropriate message
    if (importCount > 0 || updateCount > 0) {
        let message = '';
        if (importCount > 0) message += importCount + ' new metric(s) created<br>';
        if (updateCount > 0) {
            if (overwriteDuplicates) {
                message += updateCount + ' data point(s) ' + (updateCount === 1 ? 'updated/added' : 'updated/added') + '<br>';
            } else {
                message += updateCount + ' data point(s) added<br>';
            }
        }
        if (skippedCount > 0) message += '<span class="text-yellow-600">' + skippedCount + ' duplicate(s) skipped</span><br>';
        
        // Warn about non-numeric columns
        if (skippedColumns.size > 0) {
            message += '<span class="text-orange-600">‚ö†Ô∏è Skipped non-numeric columns: ' + Array.from(skippedColumns).join(', ') + '</span>';
        }
        
        document.getElementById('metricsSuccessMessage').innerHTML = message;
        document.getElementById('metricsSuccess').classList.remove('hidden');
        
        // Just close the modal after 3 seconds, stay on upload page
        setTimeout(() => {
            closeMetricsUploadModal();
        }, 3000);
    } else {
        let message = '';
        if (skippedCount > 0) {
            message += '<strong>' + skippedCount + ' row(s) were skipped:</strong><br>';
            message += '‚Ä¢ Missing required fields<br>';
            message += '‚Ä¢ Invalid date or value format<br>';
            message += '‚Ä¢ All data points already exist<br><br>';
        }
        message += '<strong>Please check:</strong><br>';
        message += '‚Ä¢ Column mappings are correct<br>';
        message += '‚Ä¢ Data format matches expectations';
        
        document.getElementById('metricsWarningMessage').innerHTML = message;
        document.getElementById('metricsWarning').classList.remove('hidden');
    }
}

// ===== PowerPoint Template Management =====
document.getElementById('openTemplatePanelBtn')?.addEventListener('click', () => {
    document.getElementById('templateManagementModal').classList.remove('hidden');
    loadTemplates();
});

function closeTemplateModal() {
    document.getElementById('templateManagementModal').classList.add('hidden');
}

const templateDropZone = document.getElementById('templateDropZoneUnified');
const templateFileInput = document.getElementById('templateFileInputUnified');
const templateFileInfo = document.getElementById('templateFileInfoUnified');
const templateFileName = document.getElementById('templateFileNameUnified');
const templateNameInput = document.getElementById('templateNameInputUnified');
const uploadTemplateBtn = document.getElementById('uploadTemplateBtnUnified');
let selectedTemplateFile = null;

// Template drop zone events
templateDropZone?.addEventListener('click', () => templateFileInput.click());
templateDropZone?.addEventListener('dragover', (e) => {
    e.preventDefault();
    templateDropZone.classList.add('border-purple-500', 'bg-purple-50');
});
templateDropZone?.addEventListener('dragleave', () => {
    templateDropZone.classList.remove('border-purple-500', 'bg-purple-50');
});
templateDropZone?.addEventListener('drop', (e) => {
    e.preventDefault();
    templateDropZone.classList.remove('border-purple-500', 'bg-purple-50');
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].name.endsWith('.pptx')) {
        handleTemplateFileSelect(files[0]);
    } else {
        alert('Please upload a .pptx PowerPoint file');
    }
});

templateFileInput?.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleTemplateFileSelect(e.target.files[0]);
    }
});

function handleTemplateFileSelect(file) {
    selectedTemplateFile = file;
    templateFileName.textContent = file.name;
    templateFileInfo.classList.remove('hidden');
    uploadTemplateBtn.disabled = false;
    
    // Auto-fill template name from filename
    const nameWithoutExt = file.name.replace('.pptx', '');
    templateNameInput.value = nameWithoutExt;
}

uploadTemplateBtn?.addEventListener('click', async () => {
    if (!selectedTemplateFile) return;
    
    const templateName = templateNameInput.value.trim() || selectedTemplateFile.name.replace('.pptx', '');
    
    const formData = new FormData();
    formData.append('file', selectedTemplateFile);
    formData.append('name', templateName);
    
    uploadTemplateBtn.disabled = true;
    uploadTemplateBtn.textContent = 'Uploading...';
    
    try {
        const response = await fetch('/upload/powerpoint-template', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Show success message
            document.getElementById('templateUploadSuccessMessage').textContent = `"${templateName}" is now available for PowerPoint exports`;
            document.getElementById('templateUploadSuccess').classList.remove('hidden');
            document.getElementById('templateUploadError').classList.add('hidden');
            
            // Reset form
            selectedTemplateFile = null;
            templateFileInput.value = '';
            templateFileInfo.classList.add('hidden');
            templateNameInput.value = '';
            uploadTemplateBtn.disabled = true;
            uploadTemplateBtn.textContent = 'üì§ Upload Template';
            
            // Reload templates list
            loadTemplates();
            
            // Hide success message after 5 seconds
            setTimeout(() => {
                document.getElementById('templateUploadSuccess').classList.add('hidden');
            }, 5000);
        } else {
            // Show error message
            document.getElementById('templateUploadErrorMessage').textContent = result.detail || 'Unknown error';
            document.getElementById('templateUploadError').classList.remove('hidden');
            document.getElementById('templateUploadSuccess').classList.add('hidden');
            uploadTemplateBtn.disabled = false;
            uploadTemplateBtn.textContent = 'üì§ Upload Template';
        }
    } catch (error) {
        console.error('Upload error:', error);
        // Show error message
        document.getElementById('templateUploadErrorMessage').textContent = error.message || 'Network error occurred';
        document.getElementById('templateUploadError').classList.remove('hidden');
        document.getElementById('templateUploadSuccess').classList.add('hidden');
        uploadTemplateBtn.disabled = false;
        uploadTemplateBtn.textContent = 'üì§ Upload Template';
    }
});

// Load templates on page load
async function loadTemplates() {
    try {
        const response = await fetch('/upload/powerpoint-templates');
        const templates = await response.json();
        
        const container = document.getElementById('templatesContainerUnified');
        
        if (templates.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500">No templates uploaded yet</p>';
            return;
        }
        
        container.innerHTML = templates.map(t => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <div>
                        <p class="font-medium text-gray-900">${t.name}</p>
                        <p class="text-xs text-gray-500">Uploaded ${new Date(t.uploaded_at).toLocaleDateString()}</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="setDefaultTemplate('${t.id}')" class="px-3 py-1 text-sm ${t.is_default ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'} rounded hover:opacity-80">
                        ${t.is_default ? '‚úì Default' : 'Set Default'}
                    </button>
                    <button onclick="deleteTemplate('${t.id}', '${t.name.replace(/'/g, "\\'")}')" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                        Delete
                    </button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to load templates:', error);
    }
}

async function setDefaultTemplate(templateId) {
    try {
        const response = await fetch(`/upload/powerpoint-template/${templateId}/set-default`, {
            method: 'POST'
        });
        if (response.ok) {
            loadTemplates();
        }
    } catch (error) {
        console.error('Failed to set default:', error);
    }
}

// Delete template with confirmation modal
let templateToDelete = null;

function deleteTemplate(templateId, templateName) {
    templateToDelete = templateId;
    document.getElementById('deleteTemplateName').textContent = templateName;
    document.getElementById('deleteTemplateModal').classList.remove('hidden');
}

function cancelDeleteTemplate() {
    templateToDelete = null;
    document.getElementById('deleteTemplateModal').classList.add('hidden');
}

async function confirmDeleteTemplate() {
    if (!templateToDelete) return;
    
    try {
        const response = await fetch(`/upload/powerpoint-template/${templateToDelete}`, {
            method: 'DELETE'
        });
        if (response.ok) {
            document.getElementById('deleteTemplateModal').classList.add('hidden');
            loadTemplates();
        } else {
            alert('Failed to delete template');
        }
    } catch (error) {
        console.error('Failed to delete template:', error);
        alert('Failed to delete template');
    }
    
    templateToDelete = null;
}

</script>

{% endblock %}

