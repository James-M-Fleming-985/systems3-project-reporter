{% extends "base.html" %}

{% block title %}Upload Data - SystemsÂ³ Project Reporter{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">ðŸ“¤ Upload Data</h2>
    <p class="text-gray-600">Upload project XML files and risk data to update your dashboard</p>
</div>

<!-- Upload Cards -->
<div class="grid md:grid-cols-3 gap-6">
    <!-- Project Data Upload Card -->
    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center mb-4">
            <svg class="w-12 h-12 text-blue-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <div>
                <h3 class="text-xl font-bold text-gray-800">Project Data</h3>
                <p class="text-sm text-gray-600">MS Project XML files</p>
            </div>
        </div>
        
        <p class="text-gray-700 mb-4">
            Upload Microsoft Project XML files to track milestones, timelines, and project progress.
        </p>
        
        <ul class="text-sm text-gray-600 mb-4 space-y-1">
            <li>âœ“ Automatic change detection</li>
            <li>âœ“ Milestone tracking</li>
            <li>âœ“ Gantt chart generation</li>
            <li>âœ“ Weekly update comparison</li>
        </ul>
        
        <button onclick="openProjectUploadModal()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
            Upload Project XML
        </button>
    </div>

    <!-- Risk Data Upload Card -->
    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center mb-4">
            <svg class="w-12 h-12 text-red-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
                <h3 class="text-xl font-bold text-gray-800">Risk Data</h3>
                <p class="text-sm text-gray-600">Excel, CSV, or YAML files</p>
            </div>
        </div>
        
        <p class="text-gray-700 mb-4">
            Upload risk registers to calculate risk scores and visualize risk distribution.
        </p>
        
        <ul class="text-sm text-gray-600 mb-4 space-y-1">
            <li>âœ“ YAML, Excel, or CSV formats</li>
            <li>âœ“ Automatic severity calculation</li>
            <li>âœ“ Risk score metrics</li>
            <li>âœ“ Distribution charts</li>
        </ul>
        
        <button onclick="openRiskUploadModal()" class="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold">
            Upload Risk Data
        </button>
    </div>

    <!-- Metrics Data Upload Card -->
    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-center mb-4">
            <svg class="w-12 h-12 text-green-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <div>
                <h3 class="text-xl font-bold text-gray-800">Metrics Data</h3>
                <p class="text-sm text-gray-600">CSV or Excel files</p>
            </div>
        </div>
        
        <p class="text-gray-700 mb-4">
            Import historical custom metric data from CSV or Excel files with optional annotations.
        </p>
        
        <ul class="text-sm text-gray-600 mb-4 space-y-1">
            <li>âœ“ CSV and Excel formats</li>
            <li>âœ“ Field mapping interface</li>
            <li>âœ“ Annotation/callout support</li>
            <li>âœ“ Bulk historical import</li>
        </ul>
        
        <button id="uploadMetricsBtn" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
            ðŸ“Š Upload Metrics Data
        </button>
    </div>
</div>

<!-- Recent Uploads -->
<div class="mt-8 bg-white rounded-lg shadow-md p-6">
    <h3 class="text-xl font-bold text-gray-800 mb-4">ðŸ“Š Recent Uploads</h3>
    <div id="recentUploads" class="text-gray-600">
        <p class="text-center py-8">No recent uploads</p>
    </div>
</div>

<!-- Project Upload Modal -->
<div id="projectUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">Upload Project XML</h3>
                <button onclick="closeProjectUploadModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Drop Zone -->
            <div id="projectDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center mb-4 cursor-pointer hover:border-blue-500 transition-colors">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-4 text-lg text-gray-600">Drag and drop MS Project XML file</p>
                <p class="text-sm text-gray-500 mt-2">or click to browse</p>
                <input type="file" id="projectFileInput" accept=".xml" class="hidden">
            </div>
            
            <div id="projectFileInfo" class="hidden bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                <p class="text-sm text-blue-800"><strong>Selected:</strong> <span id="projectFileName"></span></p>
                <p class="text-sm text-blue-600 mt-1" id="projectFileSize"></p>
            </div>
            
            <!-- Baseline Option -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-start">
                    <input type="checkbox" id="projectBaselineCheckbox" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1">
                    <label for="projectBaselineCheckbox" class="ml-3 text-sm text-gray-700">
                        <span class="font-semibold">Set as Baseline</span>
                        <p class="text-gray-600 mt-1">Skip change detection and establish this as the new baseline for future comparisons.</p>
                    </label>
                </div>
            </div>
            
            <!-- Progress -->
            <div id="projectProgress" class="hidden bg-blue-50 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <svg class="animate-spin h-5 w-5 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-700">Processing XML file...</span>
                </div>
            </div>
            
            <!-- Success Message -->
            <div id="projectSuccess" class="hidden bg-green-50 border border-green-200 rounded p-4 mb-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-green-800 font-semibold">Upload successful!</span>
                </div>
                <p class="text-sm text-green-700 mt-2" id="projectSuccessMessage"></p>
            </div>
            
            <!-- Error Message -->
            <div id="projectError" class="hidden bg-red-50 border border-red-200 rounded p-4 mb-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-red-800 font-semibold">Upload failed</span>
                </div>
                <p class="text-sm text-red-700 mt-2" id="projectErrorMessage"></p>
            </div>
            
            <button id="projectUploadBtn" onclick="uploadProjectFile()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-semibold" disabled>
                Upload Project XML
            </button>
        </div>
    </div>
</div>

<!-- Risk Upload Modal -->
<div id="riskUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">Upload Risk Data</h3>
                <button onclick="closeRiskUploadModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Program Selection -->
            <div class="mb-4">
                <label for="riskProgramSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                    Select Program <span class="text-red-500">*</span>
                </label>
                <select id="riskProgramSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    <option value="">-- Select a program --</option>
                </select>
                <p class="text-xs text-gray-600 mt-1">Select the program these risks belong to</p>
            </div>
            
            <!-- Drop Zone -->
            <div id="riskDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center mb-4 cursor-pointer hover:border-red-500 transition-colors">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-4 text-lg text-gray-600">Drag and drop risk file</p>
                <p class="text-sm text-gray-500 mt-2">YAML (.yaml, .yml), Excel (.xlsx, .xls), or CSV (.csv)</p>
                <input type="file" id="riskFileInput" accept=".yaml,.yml,.xlsx,.xls,.csv" class="hidden">
            </div>
            
            <div id="riskFileInfo" class="hidden bg-red-50 border border-red-200 rounded p-4 mb-4">
                <p class="text-sm text-red-800"><strong>Selected:</strong> <span id="riskFileName"></span></p>
                <p class="text-sm text-red-600 mt-1" id="riskFileSize"></p>
            </div>
            
            <!-- Format Examples -->
            <details class="mb-4 p-4 bg-gray-50 rounded-lg">
                <summary class="cursor-pointer font-semibold text-gray-700">ðŸ“‹ File Format Examples</summary>
                <div class="mt-4 space-y-4 text-sm">
                    <div>
                        <p class="font-semibold text-gray-800 mb-2">YAML Format:</p>
                        <pre class="bg-gray-800 text-green-400 p-3 rounded overflow-x-auto"><code>risks:
  - id: R001
    title: "Supply chain disruption"
    description: "Potential delays from supplier"
    likelihood: high  # or: low, medium, high, critical
    impact: high
    mitigations: "Identify backup suppliers"
    owner: "John Doe"
    date_identified: "2025-01-15"
    status: open</code></pre>
                    </div>
                    
                    <div>
                        <p class="font-semibold text-gray-800 mb-2">Excel/CSV Columns:</p>
                        <pre class="bg-gray-800 text-green-400 p-3 rounded overflow-x-auto"><code>ID | Title | Description | Likelihood | Impact | Mitigations | Owner | Date Identified | Status</code></pre>
                        <p class="text-gray-600 mt-2">Column names are flexible (case-insensitive)</p>
                    </div>
                </div>
            </details>
            
            <!-- Progress -->
            <div id="riskProgress" class="hidden bg-red-50 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <svg class="animate-spin h-5 w-5 text-red-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-700">Processing risk file...</span>
                </div>
            </div>
            
            <!-- Success Message -->
            <div id="riskSuccess" class="hidden bg-green-50 border border-green-200 rounded p-4 mb-4">
                <div class="flex items-center mb-2">
                    <svg class="h-5 w-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-green-800 font-semibold">Upload successful!</span>
                </div>
                <div id="riskSuccessDetails" class="text-sm text-green-700 ml-8"></div>
            </div>
            
            <!-- Error Message -->
            <div id="riskError" class="hidden bg-red-50 border border-red-200 rounded p-4 mb-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-red-800 font-semibold">Upload failed</span>
                </div>
                <p class="text-sm text-red-700 mt-2" id="riskErrorMessage"></p>
            </div>
            
            <button id="riskUploadBtn" onclick="uploadRiskFile()" class="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-semibold" disabled>
                Upload Risk Data
            </button>
        </div>
    </div>
</div>

<script>
// Modal functions
function openProjectUploadModal() {
    document.getElementById('projectUploadModal').classList.remove('hidden');
}

function closeProjectUploadModal() {
    document.getElementById('projectUploadModal').classList.add('hidden');
    resetProjectUpload();
}

function openRiskUploadModal() {
    document.getElementById('riskUploadModal').classList.remove('hidden');
    populateProgramDropdown(); // Load available programs
}

function closeRiskUploadModal() {
    document.getElementById('riskUploadModal').classList.add('hidden');
    resetRiskUpload();
}

// Project Upload Logic
let projectFile = null;

const projectDropZone = document.getElementById('projectDropZone');
const projectFileInput = document.getElementById('projectFileInput');

projectDropZone.addEventListener('click', () => projectFileInput.click());

projectDropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    projectDropZone.classList.add('border-blue-500', 'bg-blue-50');
});

projectDropZone.addEventListener('dragleave', () => {
    projectDropZone.classList.remove('border-blue-500', 'bg-blue-50');
});

projectDropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    projectDropZone.classList.remove('border-blue-500', 'bg-blue-50');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleProjectFile(files[0]);
    }
});

projectFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleProjectFile(e.target.files[0]);
    }
});

function handleProjectFile(file) {
    if (!file.name.endsWith('.xml')) {
        alert('Please select an XML file');
        return;
    }
    
    projectFile = file;
    document.getElementById('projectFileName').textContent = file.name;
    document.getElementById('projectFileSize').textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
    document.getElementById('projectFileInfo').classList.remove('hidden');
    document.getElementById('projectUploadBtn').disabled = false;
}

async function uploadProjectFile() {
    if (!projectFile) return;
    
    const formData = new FormData();
    formData.append('file', projectFile);
    
    const isBaseline = document.getElementById('projectBaselineCheckbox').checked;
    if (isBaseline) {
        formData.append('baseline', 'true');
    }
    
    // Hide previous messages
    document.getElementById('projectSuccess').classList.add('hidden');
    document.getElementById('projectError').classList.add('hidden');
    
    // Show progress
    document.getElementById('projectProgress').classList.remove('hidden');
    document.getElementById('projectUploadBtn').disabled = true;
    
    try {
        const response = await fetch('/upload/xml', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        document.getElementById('projectProgress').classList.add('hidden');
        
        if (response.ok) {
            document.getElementById('projectSuccess').classList.remove('hidden');
            document.getElementById('projectSuccessMessage').textContent = 
                `${data.project_name} uploaded successfully! ${data.changes_detected || 0} changes detected.`;
            
            // Refresh after 2 seconds
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 2000);
        } else {
            throw new Error(data.detail || 'Upload failed');
        }
    } catch (error) {
        document.getElementById('projectProgress').classList.add('hidden');
        document.getElementById('projectError').classList.remove('hidden');
        document.getElementById('projectErrorMessage').textContent = error.message;
        document.getElementById('projectUploadBtn').disabled = false;
    }
}

function resetProjectUpload() {
    projectFile = null;
    document.getElementById('projectFileInfo').classList.add('hidden');
    document.getElementById('projectSuccess').classList.add('hidden');
    document.getElementById('projectError').classList.add('hidden');
    document.getElementById('projectProgress').classList.add('hidden');
    document.getElementById('projectUploadBtn').disabled = true;
    document.getElementById('projectBaselineCheckbox').checked = false;
    projectFileInput.value = '';
}

// Risk Upload Logic
let riskFile = null;

const riskDropZone = document.getElementById('riskDropZone');
const riskFileInput = document.getElementById('riskFileInput');
const riskProgramSelect = document.getElementById('riskProgramSelect');

// Populate program dropdown on modal open
async function populateProgramDropdown() {
    try {
        // Get currently selected program from localStorage
        const selectedProgram = localStorage.getItem('selectedProgram');
        
        // Fetch all projects
        const response = await fetch('/dashboard/api/projects');
        if (!response.ok) {
            console.error('Failed to fetch projects');
            return;
        }
        
        const projects = await response.json();
        
        // Clear existing options (except first)
        riskProgramSelect.innerHTML = '<option value="">-- Select a program --</option>';
        
        // Add project options
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.name;
            option.textContent = project.name;
            
            // Pre-select if it matches localStorage
            if (selectedProgram && project.name === selectedProgram) {
                option.selected = true;
            }
            
            riskProgramSelect.appendChild(option);
        });
        
        // Update upload button state
        updateRiskUploadButton();
    } catch (error) {
        console.error('Error populating programs:', error);
    }
}

riskDropZone.addEventListener('click', () => riskFileInput.click());

riskDropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    riskDropZone.classList.add('border-red-500', 'bg-red-50');
});

riskDropZone.addEventListener('dragleave', () => {
    riskDropZone.classList.remove('border-red-500', 'bg-red-50');
});

riskDropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    riskDropZone.classList.remove('border-red-500', 'bg-red-50');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleRiskFile(files[0]);
    }
});

riskFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleRiskFile(e.target.files[0]);
    }
});

riskProgramSelect.addEventListener('change', updateRiskUploadButton);

function handleRiskFile(file) {
    const validExtensions = ['.yaml', '.yml', '.xlsx', '.xls', '.csv'];
    const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
    
    if (!validExtensions.includes(fileExt)) {
        alert('Please select a YAML, Excel, or CSV file');
        return;
    }
    
    riskFile = file;
    document.getElementById('riskFileName').textContent = file.name;
    document.getElementById('riskFileSize').textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
    document.getElementById('riskFileInfo').classList.remove('hidden');
    updateRiskUploadButton();
}

function updateRiskUploadButton() {
    const hasFile = riskFile !== null;
    const hasProgram = riskProgramSelect.value.trim() !== '';
    document.getElementById('riskUploadBtn').disabled = !(hasFile && hasProgram);
}

async function uploadRiskFile() {
    if (!riskFile || !riskProgramSelect.value.trim()) return;
    
    const formData = new FormData();
    formData.append('file', riskFile);
    formData.append('program_name', riskProgramSelect.value.trim());
    
    // Hide previous messages
    document.getElementById('riskSuccess').classList.add('hidden');
    document.getElementById('riskError').classList.add('hidden');
    
    // Show progress
    document.getElementById('riskProgress').classList.remove('hidden');
    document.getElementById('riskUploadBtn').disabled = true;
    
    try {
        const response = await fetch('/risks/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        document.getElementById('riskProgress').classList.add('hidden');
        
        if (response.ok && data.success) {
            document.getElementById('riskSuccess').classList.remove('hidden');
            const details = `
                <p>Program: <strong>${data.program_name}</strong></p>
                <p>Total Risks: <strong>${data.risk_count}</strong></p>
                <p>Critical: ${data.severity_counts.critical} | High: ${data.severity_counts.high} | Medium: ${data.severity_counts.medium} | Low: ${data.severity_counts.low}</p>
            `;
            document.getElementById('riskSuccessDetails').innerHTML = details;
            
            // Redirect to risks page after 2 seconds
            setTimeout(() => {
                window.location.href = '/dashboard/risks';
            }, 2000);
        } else {
            throw new Error(data.detail || data.message || 'Upload failed');
        }
    } catch (error) {
        document.getElementById('riskProgress').classList.add('hidden');
        document.getElementById('riskError').classList.remove('hidden');
        document.getElementById('riskErrorMessage').textContent = error.message;
        document.getElementById('riskUploadBtn').disabled = false;
    }
}

function resetRiskUpload() {
    riskFile = null;
    document.getElementById('riskFileInfo').classList.add('hidden');
    document.getElementById('riskSuccess').classList.add('hidden');
    document.getElementById('riskError').classList.add('hidden');
    document.getElementById('riskProgress').classList.add('hidden');
    document.getElementById('riskUploadBtn').disabled = true;
    document.getElementById('riskProgramSelect').value = '';
    riskFileInput.value = '';
}

// Close modals on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeProjectUploadModal();
        closeRiskUploadModal();
        closeMetricsUploadModal();
    }
});

// ==================== METRICS UPLOAD FUNCTIONALITY ====================
console.log('Initializing metrics upload...');
const uploadMetricsBtn = document.getElementById('uploadMetricsBtn');
console.log('Upload metrics button found:', uploadMetricsBtn);
let metricsUploadModal = null;
let parsedFileData = null;
let programName = localStorage.getItem('selectedProgram') || '';
console.log('Selected program:', programName);

// Clean program name
programName = programName.replace('.xml', '').replace('.xlsx', '').replace('.yaml', '').trim();
programName = programName.replace(/-\d+$/, '').trim();
console.log('Cleaned program name:', programName);

if (uploadMetricsBtn) {
    console.log('Adding click listener to metrics upload button');
    uploadMetricsBtn.addEventListener('click', showMetricsUploadModal);
} else {
    console.error('Upload metrics button NOT found in DOM!');
}

function showMetricsUploadModal() {
    if (!programName) {
        showNotification('No Program Selected', 'Please select a program from the dashboard before uploading metrics data.', 'error');
        return;
    }

    metricsUploadModal = document.createElement('div');
    metricsUploadModal.id = 'metricsUploadModal';
    metricsUploadModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    metricsUploadModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">Upload Metric Historical Data</h3>
                    <button onclick="closeMetricsUploadModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-2">Upload CSV or Excel file with historical metric data including metric name, date, value, and optional annotations.</p>
            </div>
            
            <div class="p-6">
                <!-- Step 1: File Upload -->
                <div id="metricsUploadStep1">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select File (CSV or Excel)</label>
                        <input type="file" id="metricsFileInput" accept=".csv,.xlsx,.xls" 
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                        <p class="text-xs text-gray-500 mt-1">Supported formats: CSV, Excel (.xlsx, .xls)</p>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button onclick="closeMetricsUploadModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                            Cancel
                        </button>
                        <button id="parseMetricsFileBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                            Next: Map Fields
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Field Mapping -->
                <div id="metricsUploadStep2" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                        <p class="text-sm text-blue-800"><strong>Preview:</strong> First 5 rows from your file</p>
                    </div>
                    <div class="overflow-x-auto mb-4">
                        <table class="min-w-full divide-y divide-gray-200 border">
                            <thead id="metricsPreviewTableHead" class="bg-gray-50"></thead>
                            <tbody id="metricsPreviewTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                        <p class="text-sm text-yellow-800 mb-3"><strong>Map your columns to metric fields:</strong></p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Metric Name Column *</label>
                                <select id="mapMetricName" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date Column *</label>
                                <select id="mapDate" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Value Column *</label>
                                <select id="mapValue" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Annotation/Callout Column (Optional)</label>
                                <select id="mapAnnotation" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="">-- None --</option>
                                </select>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">* Required fields</p>
                    </div>
                    
                    <div class="flex justify-end gap-3">
                        <button id="backToMetricsUploadBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                            Back
                        </button>
                        <button id="importMetricsDataBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                            Import Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(metricsUploadModal);

    // Attach event listeners
    document.getElementById('parseMetricsFileBtn').addEventListener('click', parseMetricsFile);
    document.getElementById('backToMetricsUploadBtn').addEventListener('click', () => {
        document.getElementById('metricsUploadStep1').classList.remove('hidden');
        document.getElementById('metricsUploadStep2').classList.add('hidden');
    });
    document.getElementById('importMetricsDataBtn').addEventListener('click', importMetricsData);
}

function closeMetricsUploadModal() {
    if (metricsUploadModal) {
        metricsUploadModal.remove();
        metricsUploadModal = null;
    }
    parsedFileData = null;
}

async function parseMetricsFile() {
    const fileInput = document.getElementById('metricsFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('No File Selected', 'Please select a file first', 'error');
        return;
    }

    try {
        parsedFileData = await parseFile(file);
        showMetricsFieldMapping(parsedFileData);
        document.getElementById('metricsUploadStep1').classList.add('hidden');
        document.getElementById('metricsUploadStep2').classList.remove('hidden');
    } catch (error) {
        showNotification('Parse Error', 'Error parsing file: ' + error.message, 'error');
    }
}

function parseFile(file) {
    return new Promise((resolve, reject) => {
        const fileName = file.name.toLowerCase();
        
        if (fileName.endsWith('.csv')) {
            parseCSV(file).then(resolve).catch(reject);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            parseExcel(file).then(resolve).catch(reject);
        } else {
            reject(new Error('Unsupported file format. Please use CSV or Excel.'));
        }
    });
}

function parseCSV(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const lines = text.split('\\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    reject(new Error('CSV file must have at least a header row and one data row'));
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                const rows = lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = values[i] || '';
                    });
                    return obj;
                });
                
                resolve({ headers, rows });
            } catch (error) {
                reject(new Error('Error parsing CSV file: ' + error.message));
            }
        };
        reader.onerror = () => reject(new Error('Error reading CSV file'));
        reader.readAsText(file);
    });
}

function parseExcel(file) {
    return new Promise((resolve, reject) => {
        // Load XLSX library dynamically if not already loaded
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
            script.onload = () => readExcelFile(file, resolve, reject);
            script.onerror = () => reject(new Error('Failed to load Excel parser library'));
            document.head.appendChild(script);
        } else {
            readExcelFile(file, resolve, reject);
        }
    });
}

function readExcelFile(file, resolve, reject) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            if (jsonData.length < 2) {
                reject(new Error('Excel file must have at least a header row and one data row'));
                return;
            }
            
            const headers = jsonData[0];
            const rows = jsonData.slice(1).map(row => {
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = row[i] !== undefined ? String(row[i]) : '';
                });
                return obj;
            });
            
            resolve({ headers, rows });
        } catch (error) {
            reject(new Error('Error parsing Excel file: ' + error.message));
        }
    };
    reader.onerror = () => reject(new Error('Error reading Excel file'));
    reader.readAsArrayBuffer(file);
}

function showMetricsFieldMapping(data) {
    const { headers, rows } = data;
    
    // Populate preview table
    const thead = document.getElementById('metricsPreviewTableHead');
    const tbody = document.getElementById('metricsPreviewTableBody');
    
    thead.innerHTML = '<tr>' + headers.map(h => \`<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">\${h}</th>\`).join('') + '</tr>';
    
    const previewRows = rows.slice(0, 5);
    tbody.innerHTML = previewRows.map(row => 
        '<tr>' + headers.map(h => \`<td class="px-4 py-2 text-sm text-gray-900">\${row[h] || ''}</td>\`).join('') + '</tr>'
    ).join('');
    
    // Populate mapping dropdowns
    const mapMetricName = document.getElementById('mapMetricName');
    const mapDate = document.getElementById('mapDate');
    const mapValue = document.getElementById('mapValue');
    const mapAnnotation = document.getElementById('mapAnnotation');
    
    [mapMetricName, mapDate, mapValue].forEach(select => {
        select.innerHTML = '<option value="">-- Select Column --</option>' + 
            headers.map(h => \`<option value="\${h}">\${h}</option>\`).join('');
    });
    
    // Annotation is optional
    mapAnnotation.innerHTML = '<option value="">-- None --</option>' + 
        headers.map(h => \`<option value="\${h}">\${h}</option>\`).join('');
    
    // Auto-detect columns
    headers.forEach(header => {
        const lower = header.toLowerCase();
        if (lower.includes('metric') || lower.includes('name')) {
            mapMetricName.value = header;
        } else if (lower.includes('date') || lower.includes('time') || lower.includes('week')) {
            mapDate.value = header;
        } else if (lower.includes('value') || lower.includes('amount') || lower.includes('score') || lower.includes('count')) {
            mapValue.value = header;
        } else if (lower.includes('annotation') || lower.includes('callout') || lower.includes('note') || lower.includes('comment')) {
            mapAnnotation.value = header;
        }
    });
}

function importMetricsData() {
    const metricNameCol = document.getElementById('mapMetricName').value;
    const dateCol = document.getElementById('mapDate').value;
    const valueCol = document.getElementById('mapValue').value;
    const annotationCol = document.getElementById('mapAnnotation').value;
    
    if (!metricNameCol || !dateCol || !valueCol) {
        showNotification('Missing Fields', 'Please select metric name, date, and value columns', 'error');
        return;
    }
    
    const { rows } = parsedFileData;
    
    // Load existing metrics
    const storageKey = \`customMetrics_\${programName}\`;
    let customMetrics = JSON.parse(localStorage.getItem(storageKey) || '[]');
    
    let importCount = 0;
    let updateCount = 0;
    
    rows.forEach(row => {
        const metricName = row[metricNameCol];
        const dateStr = row[dateCol];
        const valueStr = row[valueCol];
        const annotation = annotationCol ? row[annotationCol] : '';
        
        if (!metricName || !dateStr || !valueStr) return;
        
        const value = parseFloat(valueStr);
        if (isNaN(value)) return;
        
        let date;
        try {
            date = new Date(dateStr);
            if (isNaN(date.getTime())) return;
        } catch (e) {
            return;
        }
        
        // Find or create metric
        let metric = customMetrics.find(m => m.name === metricName);
        
        if (!metric) {
            // Create new metric
            metric = {
                name: metricName,
                value: value,
                target: value * 1.1,
                targetDate: '',
                unit: '',
                lastUpdated: date.toISOString(),
                history: []
            };
            customMetrics.push(metric);
            importCount++;
        }
        
        // Add to history if not duplicate
        if (!metric.history) metric.history = [];
        
        const existingEntry = metric.history.find(h => 
            new Date(h.date).toDateString() === date.toDateString()
        );
        
        if (!existingEntry) {
            const historyEntry = {
                value: value,
                date: date.toISOString()
            };
            
            // Add annotation if provided
            if (annotation && annotation.trim()) {
                historyEntry.annotation = annotation.trim();
            }
            
            metric.history.push(historyEntry);
            updateCount++;
            
            // Update current value if this is the latest date
            if (new Date(metric.lastUpdated) < date) {
                metric.value = value;
                metric.lastUpdated = date.toISOString();
            }
        }
    });
    
    // Save metrics
    localStorage.setItem(storageKey, JSON.stringify(customMetrics));
    
    closeMetricsUploadModal();
    showNotification('Import Complete', \`Metrics imported: \${importCount}\\nData points added: \${updateCount}\\n\\nGo to the Metrics tab on the dashboard to view the imported data.\`, 'success');
}
</script>

{% endblock %}
